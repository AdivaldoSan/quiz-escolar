<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avalia+    Login</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body class="login-page">

  <div class="login-box">

    <h2>ðŸ“š Login - Avalia+</h2>

    <div class="form-group">
      <input type="email" id="email" placeholder="Email">
    </div>

    <div class="form-group">
      <input type="password" id="senha" placeholder="Senha">
    </div>

    <button class="btn-login" id="btnLogin" onclick="fazerLogin()">
      Entrar
    </button>

    <a href="cadastro.html" class="link">Primeiro acesso</a>

    <div id="msg" class="msg-error"></div>

  </div>

  <script src="./js/conexao.js"></script>

  <script>
  async function fazerLogin(){

    const email = document.getElementById("email").value.trim();
    const senha = document.getElementById("senha").value.trim();
    const msg = document.getElementById("msg");
    const btn = document.getElementById("btnLogin");

    msg.style.display = "none";

    if(!email || !senha){
      msg.innerText = "Preencha todos os campos.";
      msg.style.display = "block";
      return;
    }

    // loading visual
    btn.innerHTML = '<div class="loader"></div>';
    btn.disabled = true;

    const resposta = await fetch(API, {
      method: "POST",
      body: JSON.stringify({
        tipo:"login",
        email:email,
        senha:senha
      })
    });

    const dados = await resposta.json();

    if(dados.autorizado){

      localStorage.setItem("TOKEN", dados.token);
      localStorage.setItem("NOME", dados.nome);
      localStorage.setItem("PERFIL", dados.perfil);

      if(dados.perfil === "ADMIN"){
        window.location.href = "admin.html";
      }else{
        window.location.href = "painel.html";
      }

    }else{

      btn.innerHTML = "Entrar";
      btn.disabled = false;

      if(dados.erro === "usuario_pendente"){
        msg.innerText = "Cadastro aguardando aprovaÃ§Ã£o.";
      }
      else if(dados.erro === "usuario_bloqueado"){
        msg.innerText = "UsuÃ¡rio bloqueado.";
      }
      else{
        msg.innerText = "Email ou senha incorretos.";
      }

      msg.style.display = "block";
    }
  }
  </script>

</body>
</html>
