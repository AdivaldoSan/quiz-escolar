
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Montar Quiz</title>
</head>

<body style="font-family: Arial; max-width:800px; margin:auto;">

<h2>ðŸ“˜ Montagem de Quiz</h2>

<label>Disciplina:</label>
<select id="disciplina"></select>
<br><br>

<label>Assunto:</label>
<select id="assunto"></select>
<br><br>

<label>Descritor (opcional):</label>
<select id="descritor"></select>
<br><br>

<label>Quantidade de questÃµes:</label>
<input type="number" id="quantidade" value="5">
<br><br>

<label>Nome do Quiz:</label>
<input type="text" id="nomeQuiz" placeholder="Ex: RevisÃ£o FunÃ§Ãµes 3ÂºA">
<br><br>

<button onclick="gerarQuiz()">Gerar Quiz</button>

<p id="resultado"></p>

<script src="js/conexao.js"></script>

<script>

let banco = [];
let mapaDescritores = {};

iniciar();

async function iniciar(){

    try{

        const dados = await carregarBancoCompleto();

        console.log("Dados carregados:", dados); // ajuda debug

        banco = dados.questoes.filter(q => q.ATIVO === "SIM");

        dados.descritores.forEach(d => {
            mapaDescritores[d.CODIGO] = d.DESCRICAO;
        });

        preencherSelect("disciplina",
            [...new Set(banco.map(q => q.DISCIPLINA))]
        );

        document.getElementById("disciplina")
            .addEventListener("change", atualizarFiltros);

        atualizarFiltros();

    }catch(e){

        document.body.innerHTML = `
            <h3>Erro ao carregar banco</h3>
            <pre>${e}</pre>
        `;

        console.error("ERRO:", e);
    }
}


// ==========================
function atualizarFiltros(){

    const disc = document.getElementById("disciplina").value;

    const filtrado = banco.filter(q => q.DISCIPLINA === disc);

    const assuntos = [...new Set(filtrado.map(q => q.ASSUNTO).filter(a => a))];

    const selAssunto = document.getElementById("assunto");
    selAssunto.innerHTML = "";

    assuntos.forEach(a=>{
        let op = document.createElement("option");
        op.value = a;
        op.textContent = a;
        selAssunto.appendChild(op);
    });

    const descritoresDaDisciplina =
        Object.entries(mapaDescritores)
        .filter(([cod]) =>
            banco.some(q => q.DISCIPLINA === disc && q.DESCRITOR === cod)
        );

    const campoDescritor = document.getElementById("descritor").parentElement;

    if(descritoresDaDisciplina.length === 0){
        campoDescritor.style.display = "none";
    }else{
        campoDescritor.style.display = "block";

        const selDesc = document.getElementById("descritor");
        selDesc.innerHTML = "<option value=''>Todos</option>";

        descritoresDaDisciplina.forEach(([cod, desc])=>{
            let op = document.createElement("option");
            op.value = cod;
            op.textContent = cod + " â€” " + desc;
            selDesc.appendChild(op);
        });
    }
}


// ==========================
function preencherSelect(id, lista) {
    const select = document.getElementById(id);
    select.innerHTML = "";

    lista.forEach(item => {
        let op = document.createElement("option");
        op.value = item;
        op.textContent = item;
        select.appendChild(op);
    });
}


// ==========================
function gerarQuiz() {

    const disc = disciplina.value;
    const ass = assunto.value;
    const desc = descritor.value;
    const qtd = parseInt(quantidade.value);
    const nome = nomeQuiz.value || "Quiz sem nome";

    let filtradas = banco.filter(q =>
        q.DISCIPLINA === disc &&
        q.ASSUNTO === ass &&
        (desc === "" || q.DESCRITOR === desc)
    );

    embaralhar(filtradas);

    let selecionadas = filtradas.slice(0, qtd);

    const idAplicacao = "QUIZ_" + Date.now();

    localStorage.setItem("quizAtual", JSON.stringify({
        id: idAplicacao,
        nome: nome,
        questoes: selecionadas
    }));

    window.location.href = "quiz.html";
}


// ==========================
function embaralhar(array){
    for(let i=array.length-1;i>0;i--){
        let j=Math.floor(Math.random()*(i+1));
        [array[i],array[j]]=[array[j],array[i]];
    }
}

</script>

</body>
</html>
