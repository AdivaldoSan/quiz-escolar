<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Montar Quiz</title>
</head>

<body style="font-family: Arial; max-width:800px; margin:auto;">

<h2>ðŸ“˜ Montagem de Quiz</h2>

<label>Disciplina:</label>
<select id="disciplina"></select>
<br><br>

<label>Assunto:</label>
<select id="assunto"></select>
<div id="infoAssunto" style="font-size:12px;color:#555;"></div>
<br>

<label>Descritor (opcional):</label>
<select id="descritor"></select>
<div id="infoDescritor" style="font-size:12px;color:#555;"></div>
<br>

<label>Quantidade de questÃµes:</label>
<input type="number" id="quantidade" value="5">
<br><br>

<label>Nome do Quiz:</label>
<input type="text" id="nomeQuiz" placeholder="Ex: RevisÃ£o FunÃ§Ãµes 3ÂºA">
<br><br>

<label>Turmas:</label>
<div id="listaTurmas">
    Carregando turmas...
</div>
<br><br>

<button onclick="gerarQuiz()">Gerar Quiz</button>

<p id="status"></p>

<script src="./js/conexao.js"></script>

<script>

let banco = [];
let mapaDescritores = {};

iniciar();

async function iniciar(){

    document.getElementById("status").innerText = "Carregando banco de dados...";

    const dados = await carregarBancoCompleto();

    banco = dados.questoes.filter(q => q.ATIVO === "SIM");

    dados.descritores.forEach(d=>{
        mapaDescritores[d.CODIGO] = d.DESCRICAO;
    });

    preencherSelect("disciplina",
        [...new Set(banco.map(q=>q.DISCIPLINA))]
    );

    document.getElementById("disciplina")
        .addEventListener("change", atualizarFiltros);

    document.getElementById("assunto")
        .addEventListener("change", relacionarAssuntoComDescritor);

    document.getElementById("descritor")
        .addEventListener("change", relacionarDescritorComAssunto);

    atualizarFiltros();

    await carregarTurmas();

    document.getElementById("status").innerText = "Banco carregado.";
}


// =============================
function atualizarFiltros(){

    const disc = disciplina.value;

    const filtrado = banco.filter(q=>q.DISCIPLINA===disc);

    preencherSelect("assunto",
        [...new Set(filtrado.map(q=>q.ASSUNTO))]
    );

    const descritores = [...new Set(filtrado.map(q=>q.DESCRITOR))];

    const sel = document.getElementById("descritor");
    sel.innerHTML = "<option value=''>Todos</option>";

    descritores.forEach(cod=>{
        let op = document.createElement("option");
        op.value = cod;
        op.textContent = cod + " â€” " + (mapaDescritores[cod]||"");
        sel.appendChild(op);
    });

    assunto.disabled = false;
    descritor.disabled = false;
    infoAssunto.innerHTML="";
    infoDescritor.innerHTML="";
}


// =============================
function relacionarAssuntoComDescritor(){

    if(!assunto.value){
        descritor.disabled=false;
        infoAssunto.innerHTML="";
        return;
    }

    descritor.disabled=true;

    const descrs =
        [...new Set(
            banco.filter(q=>q.ASSUNTO===assunto.value)
                 .map(q=>q.DESCRITOR)
        )];

    infoAssunto.innerHTML =
        "Descritores relacionados:<br>" +
        descrs.map(c=>c+" â€” "+(mapaDescritores[c]||"")).join("<br>");
}


// =============================
function relacionarDescritorComAssunto(){

    if(!descritor.value){
        assunto.disabled=false;
        infoDescritor.innerHTML="";
        return;
    }

    assunto.disabled=true;

    const assuntos =
        [...new Set(
            banco.filter(q=>q.DESCRITOR===descritor.value)
                 .map(q=>q.ASSUNTO)
        )];

    infoDescritor.innerHTML =
        "Aparece nos assuntos: "+assuntos.join(", ");
}


// =============================
function preencherSelect(id, lista){

    const sel=document.getElementById(id);
    sel.innerHTML="<option value=''>Todos</option>";

    lista.forEach(v=>{
        let op=document.createElement("option");
        op.value=v;
        op.textContent=v;
        sel.appendChild(op);
    });
}


// =============================
// ðŸš€ GERAR QUIZ (APENAS MONTA â€” NÃƒO SALVA AINDA)
// =============================
function gerarQuiz(){

    const disciplinaSel = document.getElementById("disciplina").value;
    const assuntoSel    = document.getElementById("assunto").value;
    const descritorSel  = document.getElementById("descritor").value;
    const quantidadeSel = parseInt(document.getElementById("quantidade").value);
    const nome          = document.getElementById("nomeQuiz").value || "Quiz";
    const selectTurmas = document.getElementById("turma");
    
    const turmasSelecionadas = 
        [...document.querySelectorAll(".chkTurma:checked")]
        .map(cb => cb.value);

            if(turmasSelecionadas.length === 0){
                alert("Selecione ao menos uma turma.");
            return;
                }

    const filtradas = banco.filter(q =>
        (disciplinaSel === "" || q.DISCIPLINA === disciplinaSel) &&
        (assuntoSel === "" || q.ASSUNTO === assuntoSel) &&
        (descritorSel === "" || q.DESCRITOR === descritorSel)
    );

    if(filtradas.length === 0){
        alert("Nenhuma questÃ£o encontrada.");
        return;
    }

    embaralhar(filtradas);
    const selecionadas = filtradas.slice(0, quantidadeSel);

    // âœ… cria o ID AQUI (Ãºnica vez!)
    const idAplicacao = "APL_" + Date.now();

    // âœ… salva TEMPORARIAMENTE para a tela de conferÃªncia
    localStorage.setItem("previewQuiz", JSON.stringify({
    id: idAplicacao,
    nome: nome,
    turmas: turmasSelecionadas,
    professor: "professoradivaldo@gmail.com",
    qtd: selecionadas.length,
    questoes: selecionadas
}));

    // ðŸ‘‰ vai para a tela de preview (ainda NÃƒO publicou)
    window.location.href = "preview.html";
}

// =============================
async function carregarTurmas(){

    const resp = await fetch(API+"?tipo=turmas&professor=professoradivaldo@gmail.com");
    const linhas = await resp.json();

    const div = document.getElementById("listaTurmas");
    div.innerHTML = "";

    if(!Array.isArray(linhas) || linhas.length <= 1){
        div.innerHTML = "Nenhuma turma encontrada.";
        return;
    }

    linhas.slice(1).forEach(l=>{

        const nomeTurma = l[2]; // NOME_TURMA

        const label = document.createElement("label");
        label.style.display = "block";
        label.style.marginBottom = "4px";

        label.innerHTML = `
            <input type="checkbox" value="${nomeTurma}" class="chkTurma">
            ${nomeTurma}
        `;

        div.appendChild(label);
    });
}

// =============================
function embaralhar(a){
for(let i=a.length-1;i>0;i--){
let j=Math.floor(Math.random()*(i+1));
[a[i],a[j]]=[a[j],a[i]];
}
}

</script>

</body>
</html>
