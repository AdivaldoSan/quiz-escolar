<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Avalia+ | Montar Quiz</title>
<link rel="stylesheet" href="styles.css">
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<link rel="alternate icon" href="favicon.ico">
</head>

<body>

<script src="./js/conexao.js"></script>
<script src="./js/layout.js"></script>

<script>

function iniciarPagina(){
    criarLayout();

    document.getElementById("conteudo").innerHTML = `
        <h2 style="margin-bottom:20px;">ðŸ“˜ Criar Simulado</h2>

        <div class="card form-card">

            <div class="form-group">
                <label>Disciplina:</label>
                <select id="disciplina"></select>
            </div>

            <div class="form-group">
                <label>NÃ­vel:</label>
                <select id="nivel">
                    <option value="">Selecione</option>
                    <option value="EF1">EF1</option>
                    <option value="EF2">EF2</option>
                    <option value="EM">EM</option>
                </select>
            </div>

            <div class="form-group">
                <label>Assunto:</label>
                <select id="assunto"></select>
                <div id="infoAssunto" class="info-text"></div>
            </div>

            <div class="form-group">
                <label>Descritor (opcional):</label>
                <select id="descritor"></select>
                <div id="infoDescritor" class="info-text"></div>
            </div>

            <div class="form-group">
                <label>Quantidade de questÃµes:</label>
                <input type="number" id="quantidade" value="5">
            </div>

            <div class="form-group">
                <label>Nome do Quiz:</label>
                <input type="text" id="nomeQuiz"
                       placeholder="Ex: RevisÃ£o FunÃ§Ãµes 3ÂºA">
            </div>

            <div class="form-group">
                <label>Turmas:</label>
                <div id="listaTurmas" class="turmas-grid">
                    Carregando turmas...
                </div>
            </div>

            <button class="btn-primary"
                    onclick="gerarQuiz()">
                Gerar Quiz
            </button>

            <p id="status" style="margin-top:15px;"></p>

        </div>
    `;

    iniciar();
}

window.onload = iniciarPagina;


// =============================
// LÃ“GICA
// =============================

let banco = [];
let mapaDescritores = {};

async function iniciar(){

    document.getElementById("status").innerText =
        "Carregando banco de dados...";

    const dados = await carregarBancoCompleto();

    banco = dados.questoes.filter(q => q.ATIVO === "SIM");

    dados.descritores.forEach(d=>{
        mapaDescritores[d.CODIGO] = d.DESCRICAO;
    });

    preencherSelect("disciplina",
        [...new Set(banco.map(q=>q.DISCIPLINA))]
    );

    document.getElementById("disciplina")
        .addEventListener("change", atualizarFiltros);

    document.getElementById("nivel")
        .addEventListener("change", atualizarFiltros);

    document.getElementById("assunto")
        .addEventListener("change", relacionarAssuntoComDescritor);

    document.getElementById("descritor")
        .addEventListener("change", relacionarDescritorComAssunto);

    await carregarTurmas();

    document.getElementById("status").innerText =
        "Banco carregado.";
}


// =============================
function atualizarFiltros(){

    const disc = disciplina.value;
    const nivelSel = nivel.value;

    if(!disc || !nivelSel){
        assunto.innerHTML = "<option value=''>Selecione disciplina e nÃ­vel</option>";
        descritor.innerHTML = "<option value=''>Selecione disciplina e nÃ­vel</option>";
        return;
    }

    const filtrado = banco.filter(q=>
        q.DISCIPLINA===disc &&
        q.NIVEL===nivelSel
    );

    preencherSelect("assunto",
        [...new Set(filtrado.map(q=>q.ASSUNTO))]
    );

    const descritores =
        [...new Set(filtrado.map(q=>q.DESCRITOR))];

    const sel = document.getElementById("descritor");
    sel.innerHTML = "<option value=''>Todos</option>";

    descritores
      .sort((a,b)=>{
          const n1=parseInt(a.replace(/\D/g,''));
          const n2=parseInt(b.replace(/\D/g,''));
          return n1-n2;
      })
      .forEach(cod=>{
        let op = document.createElement("option");
        op.value = cod;
        op.textContent =
            cod + " â€” " + (mapaDescritores[cod]||"");
        sel.appendChild(op);
    });

    assunto.disabled = false;
    descritor.disabled = false;
    infoAssunto.innerHTML="";
    infoDescritor.innerHTML="";
}


// =============================
function relacionarAssuntoComDescritor(){

    if(!assunto.value){
        descritor.disabled=false;
        infoAssunto.innerHTML="";
        return;
    }

    descritor.disabled=true;

    const descrs =
        [...new Set(
            banco.filter(q=>
                q.ASSUNTO===assunto.value &&
                q.NIVEL===nivel.value
            ).map(q=>q.DESCRITOR)
        )];

    infoAssunto.innerHTML =
        "Descritores relacionados:<br>" +
        descrs.map(c=>c+" â€” "+(mapaDescritores[c]||""))
              .join("<br>");
}


// =============================
function relacionarDescritorComAssunto(){

    if(!descritor.value){
        assunto.disabled=false;
        infoDescritor.innerHTML="";
        return;
    }

    assunto.disabled=true;

    const assuntos =
        [...new Set(
            banco.filter(q=>
                q.DESCRITOR===descritor.value &&
                q.NIVEL===nivel.value
            ).map(q=>q.ASSUNTO)
        )];

    infoDescritor.innerHTML =
        "Aparece nos assuntos: "+assuntos.join(", ");
}


// =============================
function preencherSelect(id, lista){

    const sel=document.getElementById(id);
    sel.innerHTML="<option value=''>Todos</option>";

    lista.forEach(v=>{
        let op=document.createElement("option");
        op.value=v;
        op.textContent=v;
        sel.appendChild(op);
    });
}


// =============================
function gerarQuiz(){

    const disciplinaSel =
        document.getElementById("disciplina").value;
    const nivelSel =
        document.getElementById("nivel").value;
    const assuntoSel =
        document.getElementById("assunto").value;
    const descritorSel =
        document.getElementById("descritor").value;
    const quantidadeSel =
        parseInt(document.getElementById("quantidade").value);
    const nome =
        document.getElementById("nomeQuiz").value || "Quiz";

    if(!disciplinaSel || !nivelSel){
        alert("Selecione disciplina e nÃ­vel.");
        return;
    }

    const turmasSelecionadas =
        [...document.querySelectorAll(".chkTurma:checked")]
        .map(cb => cb.value);

    if(turmasSelecionadas.length === 0){
        alert("Selecione ao menos uma turma.");
        return;
    }

    const filtradas = banco.filter(q =>
        q.DISCIPLINA === disciplinaSel &&
        q.NIVEL === nivelSel &&
        (assuntoSel === "" ||
         q.ASSUNTO === assuntoSel) &&
        (descritorSel === "" ||
         q.DESCRITOR === descritorSel)
    );

    if(filtradas.length === 0){
        alert("Nenhuma questÃ£o encontrada.");
        return;
    }

    embaralhar(filtradas);
    const selecionadas =
        filtradas.slice(0, quantidadeSel);

    const idAplicacao =
        "APL_" + Date.now();

    localStorage.setItem("previewQuiz",
        JSON.stringify({
            id: idAplicacao,
            nome: nome,
            turmas: turmasSelecionadas,
            professor:
                localStorage.getItem("NOME"),
            qtd: selecionadas.length,
            questoes: selecionadas
        })
    );

    window.location.href = "preview.html";
}


// =============================
async function carregarTurmas(){

    const token =
        localStorage.getItem("TOKEN");

    const resp =
        await fetch(API +
        "?tipo=turmas&token=" + token);

    const linhas = await resp.json();

    const div =
        document.getElementById("listaTurmas");

    div.innerHTML = "";

    if(linhas.erro){
        div.innerHTML =
            "Erro ao carregar turmas.";
        return;
    }

    if(!Array.isArray(linhas) ||
       linhas.length <= 1){
        div.innerHTML =
            "Nenhuma turma encontrada.";
        return;
    }

    linhas.slice(1).forEach(l=>{

        const nomeTurma = l[2];

        const label =
            document.createElement("label");

      label.innerHTML = `
            <input type="checkbox"
                   value="${nomeTurma}"
                   class="chkTurma">
            <span>${nomeTurma}</span>
        `;

        div.appendChild(label);
    });
}


// =============================
function embaralhar(a){
    for(let i=a.length-1;i>0;i--){
        let j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
    }
}

</script>

</body>
</html>
