<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Avalia+ | Montar Quiz</title>
<link rel="stylesheet" href="styles.css">
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<link rel="alternate icon" href="favicon.ico">
</head>

<body>

<script src="./js/conexao.js"></script>
<script src="./js/layout.js"></script>

<script>

function iniciarPagina(){
    criarLayout();

    document.getElementById("conteudo").innerHTML = `
        <h2 style="margin-bottom:20px;">ðŸ“˜ Criar Simulado...</h2>

        <div class="card form-card">

            <div class="form-group">
                <label>Disciplina:</label>
                <select id="disciplina"></select>
            </div>

            <div class="form-group">
                <label>NÃ­vel:</label>
                <select id="nivel">
                    <option value="">Selecione</option>
                    <option value="EF1">EF1</option>
                    <option value="EF2">EF2</option>
                    <option value="EM">EM</option>
                </select>
            </div>

            <div id="etapaModo" style="display:none;">
                <div class="form-group">
                    <label>Modo de geraÃ§Ã£o:</label>
                    <div class="modo-geracao">
                        <label>
                            <input type="radio" name="modo" value="ASSUNTO">
                            Por Assunto
                        </label>
                        <label>
                            <input type="radio" name="modo" value="DESCRITOR">
                            Por Descritor
                        </label>
                    </div>
                </div>
            </div>

            <div id="etapaFiltro" style="display:none;">

                <div class="form-group" id="blocoAssunto">
                    <label>Assunto:</label>
                    <div class="multi-select" id="msAssunto">
                        <div class="multi-header">Nenhum selecionado â–¼</div>
                        <div class="multi-list" id="listaAssuntos"></div>
                    </div>
                    <div id="infoAssunto" class="consolidacao"></div>
                </div>

                <div class="form-group" id="blocoDescritor" style="display:none;">
                    <label>Descritor:</label>
                    <div class="multi-select" id="msDescritor">
                        <div class="multi-header">Nenhum selecionado â–¼</div>
                        <div class="multi-list" id="listaDescritores"></div>
                    </div>
                    <<div id="infoDescritor" class="consolidacao"></div>
                </div>

            </div>

            <div id="etapaFinal" style="display:none;">

                <div class="form-group">
                    <label>Quantidade de questÃµes:</label>
                    <input type="number" id="quantidade" value="5">
                </div>

                <div class="form-group">
                    <label>Nome do Quiz:</label>
                    <input type="text" id="nomeQuiz"
                           placeholder="Ex: RevisÃ£o FunÃ§Ãµes 3ÂºA">
                </div>

                <div class="form-group">
                    <label>Turmas:</label>
                    <div id="listaTurmas" class="turmas-grid"></div>
                </div>

                <button class="btn-primary"
                        onclick="gerarQuiz()">
                    Gerar Quiz
                </button>

            </div>

        </div>
    `;

    iniciar();
}

window.onload = iniciarPagina;


// ================= VARIÃVEIS =================

let banco = [];
let mapaDescritores = {};
let modoGeracao = null;


// ================= INICIALIZAÃ‡ÃƒO =================

async function iniciar(){

    const dados = await carregarBancoCompleto();

    banco = dados.questoes.filter(q =>
        String(q.ATIVO).trim().toUpperCase() === "SIM"
    );

    dados.descritores.forEach(d=>{
        mapaDescritores[d.CODIGO] = d.DESCRICAO;
    });

    preencherSelect("disciplina",
        [...new Set(banco.map(q=>q.DISCIPLINA))]
    );

    document.getElementById("disciplina")
        .addEventListener("change", verificarEtapaInicial);

    document.getElementById("nivel")
        .addEventListener("change", verificarEtapaInicial);

    document.querySelectorAll("input[name='modo']")
        .forEach(r=>{
            r.addEventListener("change", e=>{
                modoGeracao = e.target.value;
                mostrarFiltro();
            });
        });

    configurarMultiSelect("msAssunto");
    configurarMultiSelect("msDescritor");
    document.addEventListener("click", fecharMultiSelect);

    await carregarTurmas();
}


// ================= FLUXO PROGRESSIVO =================

function verificarEtapaInicial(){

    if(disciplina.value && nivel.value){
        etapaModo.style.display = "block";
        atualizarFiltros();
    }else{
        etapaModo.style.display = "none";
        etapaFiltro.style.display = "none";
        etapaFinal.style.display = "none";
    }
}

function mostrarFiltro(){

    etapaFiltro.style.display = "block";
    etapaFinal.style.display = "none";

    limparSelecoes();

    if(modoGeracao === "ASSUNTO"){
        blocoAssunto.style.display="block";
        blocoDescritor.style.display="none";
    }else{
        blocoAssunto.style.display="none";
        blocoDescritor.style.display="block";
    }
}


// ================= FILTROS =================

function atualizarFiltros(){

    const filtrado = banco.filter(q =>
        q.DISCIPLINA === disciplina.value &&
        q.NIVEL_ENSINO === nivel.value
    );

    const listaAssuntos =
        [...new Set(filtrado.map(q=>q.ASSUNTO))];

    const listaDescritores =
        [...new Set(filtrado.map(q=>q.DESCRITOR))]
        .sort((a,b)=>parseInt(a.replace(/\D/g,'')) -
                     parseInt(b.replace(/\D/g,'')));

    listaAssuntosHTML(listaAssuntos);
    listaDescritoresHTML(listaDescritores);
}

function listaAssuntosHTML(lista){

    const div = document.getElementById("listaAssuntos");
    div.innerHTML="";

    lista.forEach(nome=>{

        const item = document.createElement("div");
        item.className="multi-item";
        item.dataset.value = nome;
        item.innerText = nome;

        item.addEventListener("click", function(){
            this.classList.toggle("selected");
            atualizarHeader("msAssunto");
            atualizarInfoAssunto();   
            verificarEtapaFinal();
        });

        div.appendChild(item);
    });
}

function listaDescritoresHTML(lista){

    const div = document.getElementById("listaDescritores");
    div.innerHTML="";

    lista.forEach(cod=>{

        const item = document.createElement("div");
        item.className="multi-item";
        item.dataset.value = cod;

        item.innerHTML = `
            <span class="descritor-codigo">${cod}</span>
            <span class="descritor-texto">
                ${mapaDescritores[cod]||""}
            </span>
        `;

        item.addEventListener("click", function(){
            this.classList.toggle("selected");
            atualizarHeader("msDescritor");
              atualizarInfoDescritor();  
            verificarEtapaFinal();
        });

        div.appendChild(item);
    });
}


// ================= ETAPA FINAL =================

function verificarEtapaFinal(){

    const selecionados =
        document.querySelectorAll(".multi-item.selected");

    if(selecionados.length > 0){
        etapaFinal.style.display="block";
    }else{
        etapaFinal.style.display="none";
    }
}

function limparSelecoes(){
    document.querySelectorAll(".multi-item")
        .forEach(el=>el.classList.remove("selected"));
    etapaFinal.style.display="none";
}


// ================= HEADER =================

function atualizarHeader(id){

    const selecionados =
        document.querySelectorAll(
            "#"+id+" .multi-list .selected"
        );

    const header =
        document.querySelector("#"+id+" .multi-header");

    if(selecionados.length === 0){
        header.innerText="Nenhum selecionado â–¼";
    }else{
        header.innerText=
            selecionados.length + " selecionado(s) â–¼";
    }
}


// ================= MULTI SELECT =================

function configurarMultiSelect(id){
    const el = document.getElementById(id);
    const header = el.querySelector(".multi-header");

    header.addEventListener("click", function(e){
        e.stopPropagation();
        document.querySelectorAll(".multi-select")
            .forEach(ms=>{
                if(ms!==el) ms.classList.remove("open");
            });
        el.classList.toggle("open");
    });
}

function fecharMultiSelect(){
    document.querySelectorAll(".multi-select")
        .forEach(ms=>ms.classList.remove("open"));
}


// ================= GERAR QUIZ =================

function gerarQuiz(){

    const assuntos =
        [...document.querySelectorAll("#listaAssuntos .selected")]
        .map(el=>el.dataset.value);

    const descritores =
        [...document.querySelectorAll("#listaDescritores .selected")]
        .map(el=>el.dataset.value);

    const filtradas = banco.filter(q=>{

        if(q.DISCIPLINA !== disciplina.value) return false;
        if(q.NIVEL_ENSINO !== nivel.value) return false;

        if(modoGeracao==="ASSUNTO")
            return assuntos.includes(q.ASSUNTO);

        if(modoGeracao==="DESCRITOR")
            return descritores.includes(q.DESCRITOR);

        return false;
    });

    if(filtradas.length===0){
        alert("Nenhuma questÃ£o encontrada.");
        return;
    }

    embaralhar(filtradas);

    const selecionadas =
        filtradas.slice(0,
            parseInt(document.getElementById("quantidade").value));

    localStorage.setItem("previewQuiz",
        JSON.stringify({
            id:"APL_"+Date.now(),
            nome: document.getElementById("nomeQuiz").value || "Quiz",
            turmas:
              [...document.querySelectorAll(".chkTurma:checked")]
              .map(cb=>cb.value),
            questoes: selecionadas
        })
    );

    window.location.href="preview.html";
}


// ================= AUXILIARES =================

function preencherSelect(id, lista){
    const sel=document.getElementById(id);
    sel.innerHTML="<option value=''>Selecione</option>";
    lista.forEach(v=>{
        let op=document.createElement("option");
        op.value=v;
        op.textContent=v;
        sel.appendChild(op);
    });
}

async function carregarTurmas(){

    const token=localStorage.getItem("TOKEN");

    const resp=
        await fetch(API+"?tipo=turmas&token="+token);

    const linhas=await resp.json();

    const div=document.getElementById("listaTurmas");
    div.innerHTML="";

    if(!Array.isArray(linhas)||linhas.length<=1){
        div.innerHTML="Nenhuma turma encontrada.";
        return;
    }

    linhas.slice(1).forEach(l=>{
        const nomeTurma=l[2];

        const label=document.createElement("label");

        label.innerHTML=`
            <input type="checkbox"
                   value="${nomeTurma}"
                   class="chkTurma">
            <span>${nomeTurma}</span>
        `;

        div.appendChild(label);
    });
}

function embaralhar(a){
    for(let i=a.length-1;i>0;i--){
        let j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
    }
}

    // ================= CONSOLIDAÃ‡ÃƒO =================

function atualizarInfoAssunto(){

    const assuntos =
        [...document.querySelectorAll("#listaAssuntos .selected")]
        .map(el=>el.dataset.value);

    let html = "";

    assuntos.forEach(a=>{

        const descrs =
            [...new Set(
                banco.filter(q =>
                    q.ASSUNTO === a &&
                    q.NIVEL_ENSINO === nivel.value
                ).map(q=>q.DESCRITOR)
            )];

        html += "<div class='info-bloco'>";
        html += "<div class='info-titulo'>" + a + "</div>";

        descrs.forEach(d=>{
            html +=
                "<div class='info-item'>" +
                "<span class='descritor-codigo'>" + d + "</span>" +
                "<span class='descritor-texto'>" +
                (mapaDescritores[d] || "") +
                "</span></div>";
        });

        html += "</div>";
    });

    document.getElementById("infoAssunto").innerHTML = html;
}

function atualizarInfoDescritor(){

    const descritores =
        [...document.querySelectorAll("#listaDescritores .selected")]
        .map(el=>el.dataset.value);

    let html = "";

    descritores.forEach(d=>{
        html +=
            "<div class='info-item'>" +
            "<span class='descritor-codigo'>" + d + "</span>" +
            "<span class='descritor-texto'>" +
            (mapaDescritores[d] || "") +
            "</span></div>";
    });

    document.getElementById("infoDescritor").innerHTML = html;
}

</script>

</body>
</html>
