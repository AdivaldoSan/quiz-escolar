<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Montar Quiz</title>
</head>

<body style="font-family: Arial; max-width:800px; margin:auto;">

<h2>ðŸ“˜ Montagem de Quiz</h2>

<label>Disciplina:</label>
<select id="disciplina"></select>
<br><br>

<label>Assunto:</label>
<select id="assunto"></select>
<div id="infoAssunto" style="font-size:12px;color:#555;"></div>
<br>

<label>Descritor (opcional):</label>
<select id="descritor"></select>
<div id="infoDescritor" style="font-size:12px;color:#555;"></div>
<br>

<label>Quantidade de questÃµes:</label>
<input type="number" id="quantidade" value="5">
<br><br>

<label>Nome do Quiz:</label>
<input type="text" id="nomeQuiz" placeholder="Ex: RevisÃ£o FunÃ§Ãµes 3ÂºA">
<br><br>

<label>Turma:</label>
<select id="turma">
    <option value="">Carregando turmas...</option>
</select>
<br><br>

<button onclick="gerarQuiz()">Gerar Quiz</button>

<p id="status"></p>

<script src="./js/conexao.js"></script>

<script>

let banco = [];
let mapaDescritores = {};

iniciar();

async function iniciar(){

    document.getElementById("status").innerText = "Carregando banco de dados...";

    const dados = await carregarBancoCompleto();

    banco = dados.questoes.filter(q => q.ATIVO === "SIM");
    carregarTurmas();
    dados.descritores.forEach(d=>{
        mapaDescritores[d.CODIGO] = d.DESCRICAO;
    });

    preencherSelect("disciplina",
        [...new Set(banco.map(q=>q.DISCIPLINA))]
    );

    document.getElementById("disciplina")
        .addEventListener("change", atualizarFiltros);

    document.getElementById("assunto")
        .addEventListener("change", relacionarAssuntoComDescritor);

    document.getElementById("descritor")
        .addEventListener("change", relacionarDescritorComAssunto);

    atualizarFiltros();

    document.getElementById("status").innerText = "Banco de dados carregado.";
}



// =============================
// Atualiza lista ao trocar disciplina
// =============================
function atualizarFiltros(){

    const disc = disciplina.value;

    const filtrado = banco.filter(q=>q.DISCIPLINA===disc);

    preencherSelect("assunto",
        [...new Set(filtrado.map(q=>q.ASSUNTO))]
    );

    const descritores = [...new Set(filtrado.map(q=>q.DESCRITOR))];

    const sel = document.getElementById("descritor");
    sel.innerHTML = "<option value=''>Todos</option>";

    descritores.forEach(cod=>{
        let op = document.createElement("option");
        op.value = cod;
        op.textContent = cod + " â€” " + (mapaDescritores[cod]||"");
        sel.appendChild(op);
    });

    assunto.disabled = false;
    descritor.disabled = false;

    infoAssunto.innerHTML="";
    infoDescritor.innerHTML="";
}



// =============================
// Quando escolhe ASSUNTO
// =============================
function relacionarAssuntoComDescritor(){

    if(!assunto.value){
        descritor.disabled=false;
        infoAssunto.innerHTML="";
        return;
    }

    descritor.disabled=true;

    const descrs =
        [...new Set(
            banco.filter(q=>q.ASSUNTO===assunto.value)
                 .map(q=>q.DESCRITOR)
        )];

    infoAssunto.innerHTML =
        "Descritores relacionados:<br>" +
        descrs.map(c=>c+" â€” "+(mapaDescritores[c]||"")).join("<br>");
}



// =============================
// Quando escolhe DESCRITOR
// =============================
function relacionarDescritorComAssunto(){

    if(!descritor.value){
        assunto.disabled=false;
        infoDescritor.innerHTML="";
        return;
    }

    assunto.disabled=true;

    const assuntos =
        [...new Set(
            banco.filter(q=>q.DESCRITOR===descritor.value)
                 .map(q=>q.ASSUNTO)
        )];

    infoDescritor.innerHTML =
        "Aparece nos assuntos: "+assuntos.join(", ");
}



// =============================
function preencherSelect(id, lista){

    const sel=document.getElementById(id);
    sel.innerHTML="<option value=''>Todos</option>";

    lista.forEach(v=>{
        let op=document.createElement("option");
        op.value=v;
        op.textContent=v;
        sel.appendChild(op);
    });
}



// =============================
function gerarQuiz(){

    const disciplinaSel = document.getElementById("disciplina").value;
    const assuntoSel    = document.getElementById("assunto").value;
    const descritorSel  = document.getElementById("descritor").value;
    const quantidadeSel = parseInt(document.getElementById("quantidade").value);
    const nome          = document.getElementById("nomeQuiz").value || "Quiz sem nome";
    const turma         = document.getElementById("turma").value;
    
    const filtradas = banco.filter(q =>
        (disciplinaSel === "" || q.DISCIPLINA === disciplinaSel) &&
        (assuntoSel === "" || q.ASSUNTO === assuntoSel) &&
        (descritorSel === "" || q.DESCRITOR === descritorSel)
    );

    if(filtradas.length === 0){
        alert("Nenhuma questÃ£o encontrada com esse filtro.");
        return;
    }

    embaralhar(filtradas);

    const selecionadas = filtradas.slice(0, quantidadeSel);

    // âœ… CRIA O ID DA APLICAÃ‡ÃƒO (FALTAVA ISSO)
    const idAplicacao = "QUIZ_" + Date.now();

    localStorage.setItem("quizAtual", JSON.stringify({
        id: idAplicacao,
        nome: nome,
        professor: "professoradivaldo@gmail.com",
        turma: turma,
        questoes: selecionadas
    }));

    window.location.href = "quiz.html";
}

async function carregarTurmas(){

    const professorEmail = "professoradivaldo@gmail.com"; // depois vamos dinamizar

    const resp = await fetch(API + "?tipo=turmas&professor=" + professorEmail);
    const linhas = await resp.json();

    const select = document.getElementById("turma");
    select.innerHTML = "";

    if(linhas.length <= 1){
        select.innerHTML = "<option value=''>Nenhuma turma cadastrada</option>";
        return;
    }

    linhas.slice(1).forEach(l=>{
        const op = document.createElement("option");
        op.value = l[2];      // NOME_TURMA
        op.textContent = l[2];
        select.appendChild(op);
    });
}

// =============================
function embaralhar(a){
for(let i=a.length-1;i>0;i--){
let j=Math.floor(Math.random()*(i+1));
[a[i],a[j]]=[a[j],a[i]];
}
}

</script>

</body>
</html>
