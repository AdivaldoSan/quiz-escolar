
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Montar Quiz</title>
</head>

<body style="font-family: Arial; max-width:800px; margin:auto;">

<h2>üìò Montagem de Quiz</h2>

<label>Disciplina:</label>
<select id="disciplina"></select>
<br><br>

<label>Assunto:</label>
<select id="assunto"></select>
<br><br>

<label>Descritor (opcional):</label>
<select id="descritor"></select>
<br><br>

<label>Quantidade de quest√µes:</label>
<input type="number" id="quantidade" value="5">
<br><br>

<label>Nome do Quiz:</label>
<input type="text" id="nomeQuiz" placeholder="Ex: Revis√£o Fun√ß√µes 3¬∫A">
<br><br>

<button onclick="gerarQuiz()">Gerar Quiz</button>

<p id="resultado"></p>

<script src="js/conexao.js"></script>

<script>

let banco = [];
let mapaDescritores = {};

// ==========================
// CARREGA BANCO VIA API
// ==========================
carregarBancoCompleto().then(({questoes, descritores}) => {

    banco = questoes.filter(q => q.ATIVO === "SIM");

    // cria mapa CODIGO -> DESCRICAO
    descritores.forEach(d => {
        mapaDescritores[d.CODIGO] = d.DESCRICAO;
    });

    // preenche apenas disciplinas primeiro
    preencherSelect("disciplina",
        [...new Set(banco.map(q => q.DISCIPLINA))]
    );

    // quando mudar disciplina ‚Üí atualiza filtros
    document.getElementById("disciplina").addEventListener("change", atualizarFiltros);

    // primeira carga autom√°tica
    atualizarFiltros();
});


// ==========================
// ATUALIZA ASSUNTO + DESCRITOR
// ==========================
function atualizarFiltros(){

    const disc = document.getElementById("disciplina").value;

    const filtrado = banco.filter(q => q.DISCIPLINA === disc);

    // ==========================
    // ASSUNTOS (sempre existem)
    // ==========================
    const assuntos = [...new Set(filtrado.map(q => q.ASSUNTO).filter(a => a))];

    const selAssunto = document.getElementById("assunto");
    selAssunto.innerHTML = "";

    assuntos.forEach(a=>{
        let op = document.createElement("option");
        op.value = a;
        op.textContent = a;
        selAssunto.appendChild(op);
    });

    // ==========================
    // VERIFICA SE DISCIPLINA TEM DESCRITOR
    // ==========================
    const descritoresDaDisciplina =
        Object.entries(mapaDescritores)
        .filter(([cod, desc]) =>
            banco.some(q => q.DISCIPLINA === disc && q.DESCRITOR === cod)
        );

    const campoDescritor = document.getElementById("descritor").parentElement;

    if(descritoresDaDisciplina.length === 0){
        // ‚ùå disciplina sem matriz ‚Üí esconder campo
        campoDescritor.style.display = "none";
    }else{
        // ‚úî disciplina com matriz ‚Üí mostrar campo
        campoDescritor.style.display = "block";

        const selDesc = document.getElementById("descritor");
        selDesc.innerHTML = "<option value=''>Todos</option>";

        descritoresDaDisciplina.forEach(([cod, desc])=>{
            let op = document.createElement("option");
            op.value = cod;
            op.textContent = cod + " ‚Äî " + desc;
            selDesc.appendChild(op);
        });
    }
}


// ==========================
// FUN√á√ÉO AUXILIAR
// ==========================
function preencherSelect(id, lista) {
    const select = document.getElementById(id);
    select.innerHTML = "";
    lista.forEach(item => {
        let op = document.createElement("option");
        op.value = item;
        op.textContent = item;
        select.appendChild(op);
    });
}


// ==========================
// GERA O QUIZ
// ==========================
function gerarQuiz() {

    const disc = disciplina.value;
    const ass = assunto.value;
    const desc = descritor.value;
    const qtd = parseInt(quantidade.value);
    const nome = nomeQuiz.value || "Quiz sem nome";

    let filtradas = banco.filter(q =>
        q.DISCIPLINA === disc &&
        q.ASSUNTO === ass &&
        (desc === "" || q.DESCRITOR === desc)
    );

    embaralhar(filtradas);

    let selecionadas = filtradas.slice(0, qtd);

    const idAplicacao = "QUIZ_" + Date.now();

    localStorage.setItem("quizAtual", JSON.stringify({
        id: idAplicacao,
        nome: nome,
        questoes: selecionadas
    }));

    window.location.href = "quiz.html";
}


// ==========================
function embaralhar(array){
    for(let i=array.length-1;i>0;i--){
        let j=Math.floor(Math.random()*(i+1));
        [array[i],array[j]]=[array[j],array[i]];
    }
}

</script>

</body>
</html>
