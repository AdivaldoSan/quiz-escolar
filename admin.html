<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Painel Administrativo</title>
</head>

<body style="font-family: Arial; margin:40px;">

<h2>üë®‚Äçüíº Painel Administrativo</h2>

<div style="margin-bottom:20px;">
  <span id="usuario"></span>
  <button onclick="logout()" style="margin-left:20px;">Sair</button>
</div>

<hr>

<h3>Professores Cadastrados</h3>

<table border="1" cellpadding="8" cellspacing="0" width="100%" id="tabelaProf">
</table>

<script src="js/conexao.js"></script>

<script>

const token = localStorage.getItem("TOKEN");

if(!token){
  window.location.href = "index.html";
}

async function validarAdmin(){

  const resposta = await fetch(API + "?tipo=listarProfessores&token=" + token);
  const dados = await resposta.json();

  if(dados.erro){
    window.location.href = "index.html";
    return;
  }

  document.getElementById("usuario").innerText =
    "Logado como ADMIN";

  montarTabela(dados);
}

function montarTabela(dados){

  const tabela = document.getElementById("tabelaProf");
  tabela.innerHTML = "";

  const cab = dados[0];

  // √≠ndices importantes
  const idxID = cab.indexOf("ID");
  const idxNome = cab.indexOf("NOME");
  const idxEmail = cab.indexOf("EMAIL");
  const idxPerfil = cab.indexOf("PERFIL");
  const idxStatus = cab.indexOf("STATUS");
  const idxData = cab.indexOf("DATA_CADASTRO");

  // Cabe√ßalho
  const header = document.createElement("tr");

  ["ID","NOME","EMAIL","PERFIL","STATUS","DATA_CADASTRO","A√á√ïES"]
    .forEach(texto=>{
      const th = document.createElement("th");
      th.innerText = texto;
      header.appendChild(th);
    });

  tabela.appendChild(header);

  // Linhas
  for(let i=1;i<dados.length;i++){

    const linha = document.createElement("tr");

    const id = dados[i][idxID];
    const nome = dados[i][idxNome];
    const email = dados[i][idxEmail];
    const perfil = dados[i][idxPerfil];
    const status = dados[i][idxStatus];
    const data = dados[i][idxData];

    [id,nome,email,perfil,status,data].forEach(valor=>{
      const td = document.createElement("td");
      td.innerText = valor;
      linha.appendChild(td);
    });

    const tdAcoes = document.createElement("td");

    if(status === "PENDENTE"){
      tdAcoes.innerHTML =
        `<button onclick="alterarStatus('${email}','APROVADO')">Aprovar</button>`;
    }
    else if(status === "APROVADO"){
      tdAcoes.innerHTML =
        `<button onclick="alterarStatus('${email}','BLOQUEADO')">Bloquear</button>`;
    }
    else if(status === "BLOQUEADO"){
      tdAcoes.innerHTML =
        `<button onclick="alterarStatus('${email}','APROVADO')">Reativar</button>`;
    }

    linha.appendChild(tdAcoes);
    tabela.appendChild(linha);
  }
}

async function alterarStatus(email, novoStatus){

  const resposta = await fetch(API, {
    method:"POST",
    body: JSON.stringify({
      tipo:"alterarStatusProfessor",
      token:token,
      emailProfessor:email,
      novoStatus:novoStatus
    })
  });

  const dados = await resposta.json();

  if(dados.mensagem){
    alert("Status atualizado.");
    validarAdmin();
  }else{
    alert("Erro ao atualizar.");
  }
}

function logout(){
  localStorage.clear();
  window.location.href = "index.html";
}

validarAdmin();

</script>

</body>
</html>
