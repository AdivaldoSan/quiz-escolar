<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Painel Administrativo</title>
</head>

<body style="font-family: Arial; margin:40px;">

<h2>üë®‚Äçüíº Painel Administrativo</h2>

<div style="margin-bottom:20px;">
  <span id="usuario"></span>
  <button onclick="logout()" style="margin-left:20px;">Sair</button>
</div>

<hr>

<h3>Professores Cadastrados</h3>

<table border="1" cellpadding="8" cellspacing="0" width="100%" id="tabelaProf">
</table>

<script src="js/conexao.js"></script>

<script src="./js/layout.js"></script>
<script>
criarLayout();
</script>

<script>

const token = localStorage.getItem("TOKEN");

if(!token){
  window.location.href = "index.html";
}

async function validarAdmin(){

  const resposta = await fetch(API + "?tipo=listarProfessores&token=" + token);
  const dados = await resposta.json();

  if(dados.erro){
    window.location.href = "index.html";
    return;
  }

  document.getElementById("usuario").innerText =
    "Logado como ADMIN";

  montarTabela(dados);
}

function montarTabela(dados){

  const tabela = document.getElementById("tabelaProf");
  tabela.innerHTML = "";

  const cab = dados[0];

  const idxID = cab.indexOf("ID");
  const idxNome = cab.indexOf("NOME");
  const idxEmail = cab.indexOf("EMAIL");
  const idxPerfil = cab.indexOf("PERFIL");
  const idxStatus = cab.indexOf("STATUS");
  const idxData = cab.indexOf("DATA_CADASTRO");
  const idxEscola = cab.indexOf("ESCOLA");
  const idxCidade = cab.indexOf("CIDADE");
  const idxEstado = cab.indexOf("ESTADO");
  const idxDisciplina = cab.indexOf("DISCIPLINA");

  const header = document.createElement("tr");

  [
    "ID",
    "NOME",
    "EMAIL",
    "ESCOLA",
    "CIDADE",
    "ESTADO",
    "DISCIPLINA",
    "PERFIL",
    "STATUS",
    "DATA_CADASTRO",
    "A√á√ïES"
  ].forEach(texto=>{
    const th = document.createElement("th");
    th.innerText = texto;
    header.appendChild(th);
  });

  tabela.appendChild(header);

  for(let i=1;i<dados.length;i++){

    const linha = document.createElement("tr");

    const id = dados[i][idxID];
    const nome = dados[i][idxNome];
    const email = dados[i][idxEmail];
    const escola = dados[i][idxEscola];
    const cidade = dados[i][idxCidade];
    const estado = dados[i][idxEstado];
    const disciplina = dados[i][idxDisciplina];
    const perfil = dados[i][idxPerfil];
    const status = dados[i][idxStatus];
    const data = dados[i][idxData];

    [
      id,
      nome,
      email,
      escola,
      cidade,
      estado,
      disciplina,
      perfil,
      status,
      data
    ].forEach(valor=>{
      const td = document.createElement("td");
      td.innerText = valor || "";
      linha.appendChild(td);
    });

    const tdAcoes = document.createElement("td");

    if(status === "PENDENTE"){
      tdAcoes.innerHTML =
        `<button onclick="alterarStatus('${email}','APROVADO', this)">Aprovar</button>`;
    }
    else if(status === "APROVADO"){
      tdAcoes.innerHTML =
        `<button onclick="alterarStatus('${email}','BLOQUEADO', this)">Bloquear</button>`;
    }
    else if(status === "BLOQUEADO"){
      tdAcoes.innerHTML =
        `<button onclick="alterarStatus('${email}','APROVADO', this)">Reativar</button>`;
    }

    linha.appendChild(tdAcoes);
    tabela.appendChild(linha);
  }
}

async function alterarStatus(email, novoStatus, botao){

  const resposta = await fetch(API, {
    method:"POST",
    body: JSON.stringify({
      tipo:"alterarStatusProfessor",
      token:token,
      emailProfessor:email,
      novoStatus:novoStatus
    })
  });

  const dados = await resposta.json();

  if(dados.mensagem){

    const linha = botao.closest("tr");
    linha.children[8].innerText = novoStatus; // coluna STATUS

    if(novoStatus === "APROVADO"){
      botao.innerText = "Bloquear";
      botao.setAttribute("onclick",
        `alterarStatus('${email}','BLOQUEADO', this)`
      );
    }
    else if(novoStatus === "BLOQUEADO"){
      botao.innerText = "Reativar";
      botao.setAttribute("onclick",
        `alterarStatus('${email}','APROVADO', this)`
      );
    }

  }else{
    alert("Erro ao atualizar.");
  }
}

validarAdmin();

</script>

</body>
</html>
