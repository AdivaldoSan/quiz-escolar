<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Responder Quiz</title>
</head>

<body style="font-family:Arial;max-width:700px;margin:auto;">

<h2 id="tituloQuiz"></h2>

<div id="areaQuestao"></div>

<br>
<button id="btnAvancar" onclick="avancar()" style="display:none;">
    Avan√ßar
</button>

<p id="contador"></p>

<script>
const API = "https://script.google.com/macros/s/AKfycbzF851oMa1MMZ8OaBGuA4kENlkWaDIa0TJTxsurb5QOMIrIdrbOl8Lo5__KA-VBPHZt8w/exec";


// ===========================
// FUN√á√ÉO DE EMBARALHAR
// ===========================
function embaralharArray(arr){
    for(let i = arr.length-1; i>0; i--){
        let j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
}


// ===========================
// RECUPERA QUIZ
// ===========================
let quiz = JSON.parse(localStorage.getItem("quizAtual"));

if(!quiz){
    document.body.innerHTML = "<h3>Atividade finalizada ou inv√°lida.</h3>";
    throw new Error("quiz n√£o encontrado");
}    

// garante que os campos de identifica√ß√£o existam
quiz.alunoNome = quiz.alunoNome || "";
quiz.alunoTurma = quiz.alunoTurma || "";

if(!quiz){
    document.body.innerHTML = "<h3>Quiz n√£o encontrado.</h3>";
    throw new Error("quizAtual n√£o existe");
}


// ===========================
// EMBARALHA QUEST√ïES (UMA VEZ)
// ===========================
if(!quiz.embaralhado){
    quiz.questoes = embaralharArray(quiz.questoes);
    quiz.embaralhado = true;
    localStorage.setItem("quizAtual", JSON.stringify(quiz));
}


// ===========================
// RESTAURA PROGRESSO
// ===========================
let enviando = false;
let atual = quiz.atual || 0;
let respostas = quiz.respostas || [];

document.getElementById("tituloQuiz").innerText = quiz.nome;

iniciarIdentificacao();


// ===========================
// MOSTRAR QUEST√ÉO
// ===========================
function mostrarQuestao(){

    const q = quiz.questoes[atual];

    document.getElementById("contador").innerText =
        "Quest√£o " + (atual+1) + " de " + quiz.questoes.length;

    document.getElementById("btnAvancar").style.display = "inline-block";

    // ===============================
    // EMBARALHA ALTERNATIVAS UMA VEZ
    // ===============================
    let alternativas;

    if(!q.ordemExibida){

        alternativas = [
            {letra:"A", texto:q.ALT_A},
            {letra:"B", texto:q.ALT_B},
            {letra:"C", texto:q.ALT_C},
            {letra:"D", texto:q.ALT_D}
        ];

        alternativas = embaralharArray(alternativas);

        q.ordemExibida = alternativas;
        localStorage.setItem("quizAtual", JSON.stringify(quiz));

    }else{
        alternativas = q.ordemExibida;
    }


    // ===============================
    // RENDERIZA QUEST√ÉO
    // ===============================
    document.getElementById("areaQuestao").innerHTML = `
        <p><b>${q.ENUNCIADO}</b></p>

        ${alternativas.map((alt,i)=>`
            <label>
                <input type="radio" name="resp" value="${alt.letra}">
                ${String.fromCharCode(97+i)}) ${alt.texto}
            </label><br><br>
        `).join("")}
    `;


    // ===============================
    // RESTAURA RESPOSTA
    // ===============================
    const respAnterior = respostas.find(r => r.questao === q.ID);

    if(respAnterior){
        const radio = document.querySelector(
            `input[name="resp"][value="${respAnterior.marcada}"]`
        );
        if(radio) radio.checked = true;
    }


    if(atual === quiz.questoes.length-1){
        document.getElementById("btnAvancar").innerText = "Finalizar";
    }
}


// ===========================
// AVAN√áAR QUEST√ÉO
// ===========================
function avancar(){

    const marcada = document.querySelector('input[name="resp"]:checked');

    if(!marcada){
        alert("Marque uma alternativa.");
        return;
    }

    respostas.push({
        questao: quiz.questoes[atual].ID,
        marcada: marcada.value,
        correta: quiz.questoes[atual].GABARITO
    });

    atual++;

    // salva progresso
    quiz.atual = atual;
    quiz.respostas = respostas;
    localStorage.setItem("quizAtual", JSON.stringify(quiz));

    if(atual >= quiz.questoes.length){
        finalizar();
        return;
    }

    mostrarQuestao();
}


// ===========================
// FINALIZAR QUIZ
// ===========================


async function finalizar(){
    document.getElementById("btnAvancar").style.display = "none";

    // üîí impede envio duplicado
    if(enviando) return;
    enviando = true;

    const btn = document.getElementById("btnAvancar");
    btn.disabled = true;
    btn.innerText = "Enviando...";

    let acertos = respostas.filter(r=>r.marcada===r.correta).length;

    // pacote que ser√° enviado para API
    const envio = respostas.map(r => ({
    aplicacao: quiz.id,   // üî• usar ID, n√£o nome
    nomeQuiz: quiz.nome,  // opcional, s√≥ informativo
    aluno: quiz.alunoNome,
    turma: quiz.alunoTurma,
    questao: r.questao,
    marcada: r.marcada,
    correta: r.correta
}));

    try{

      await fetch(API, {
    method:"POST",
    body: JSON.stringify({
        tipo:"respostas",
        payload: envio
    })
});

        // pequeno delay visual (UX)
        await new Promise(r => setTimeout(r, 600));

        // agora sim limpa o estado salvo
        localStorage.removeItem("quizAtual");

        document.body.innerHTML = `
            <h2>Quiz finalizado</h2>
            <p>Acertos: ${acertos} de ${respostas.length}</p>
            <p>Respostas registradas com sucesso.</p>
        `;

    }catch(e){

        btn.disabled = false;
        btn.innerText = "Tentar novamente";
        enviando = false;

        alert("Erro ao enviar respostas. Verifique a conex√£o e tente novamente.");
    }
}

async function iniciarIdentificacao(){
    document.getElementById("btnAvancar").style.display = "none";

    if(quiz.alunoNome){
        mostrarQuestao();
        return;
    }

    const r = await fetch(API+"?tipo=turmas&professor="+quiz.professor);
    const dados = await r.json();
    const turmas = dados.slice(1);

    document.body.innerHTML = `
        <h2>${quiz.nome}</h2>

        <label>Seu nome:</label><br>
        <input id="nomeAluno" style="width:100%;padding:8px"><br><br>

        <label>Sua turma:</label><br>
        <select id="turmaAluno" style="width:100%;padding:8px">
            ${turmas.map(t=>`<option value="${t[2]}">${t[2]}</option>`).join("")}
        </select><br><br>

        <button onclick="confirmarAluno()">Iniciar</button>
    `;
}

function confirmarAluno(){

    const nome = document.getElementById("nomeAluno").value.trim();
    const turma = document.getElementById("turmaAluno").value;

    if(!nome){
        alert("Digite seu nome.");
        return;
    }

    quiz.alunoNome = nome;
    quiz.alunoTurma = turma;

    localStorage.setItem("quizAtual", JSON.stringify(quiz));

    location.reload();
}    
    
</script>

</body>
</html>
