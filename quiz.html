<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Responder Quiz</title>
<link rel="stylesheet" href="styles.css">
</head>

<body class="quiz-page">

<div class="quiz-header">
    <div class="quiz-titulo" id="tituloQuiz"></div>
    <div class="quiz-info" id="infoAluno"></div>
</div>

<div class="quiz-container">

    <div class="barra-progresso">
        <div class="barra-preenchimento" id="barra"></div>
    </div>
    
    <div id="alertaQuiz" class="alerta" style="display:none;"></div>
    
    <div id="areaQuestao" class="card questao-card"></div>

    <div class="quiz-rodape">
        <div id="contador" class="contador-questao"></div>

        <button id="btnAvancar"
                class="btn-avancar"
                onclick="avancar()"
                style="display:none;">
            Avan√ßar
        </button>
    </div>

</div>

<script src="./js/conexao.js"></script>

<script>

// ===========================
// ALERTA INTERNO
// ===========================
function mostrarAlerta(mensagem){
    const box = document.getElementById("alertaQuiz");
    box.innerText = mensagem;
    box.style.display = "block";

    setTimeout(()=>{
        box.style.display = "none";
    }, 3000);
}


// ===========================
// EMBARALHAR
// ===========================
function embaralharArray(arr){
    for(let i = arr.length-1; i>0; i--){
        let j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
}


// ===========================
// RECUPERA QUIZ
// ===========================
let quiz = JSON.parse(localStorage.getItem("quizAtual"));

if(!quiz){
    document.body.innerHTML = `
        <div class="final-card">
            <h2>Atividade indispon√≠vel</h2>
            <p>
                Esta atividade j√° foi finalizada ou o link n√£o √© mais v√°lido.
            </p>
            <p>
                Se acredita que isso √© um erro, procure seu professor.
            </p>
        </div>
    `;
    throw new Error("quiz n√£o encontrado");
}

quiz.alunoNome = quiz.alunoNome || "";
quiz.alunoTurma = quiz.alunoTurma || "";


// ===========================
// EMBARALHA QUEST√ïES
// ===========================
if(!quiz.embaralhado){
    quiz.questoes = embaralharArray(quiz.questoes);
    quiz.embaralhado = true;
    localStorage.setItem("quizAtual", JSON.stringify(quiz));
}


// ===========================
let enviando = false;
let atual = quiz.atual || 0;
let respostas = quiz.respostas || [];

document.getElementById("tituloQuiz").innerText = quiz.nome;

iniciarIdentificacao();


// ===========================
// MOSTRAR QUEST√ÉO
// ===========================
function mostrarQuestao(){

    atualizarCabecalho();

    const q = quiz.questoes[atual];

    document.getElementById("contador").innerHTML =
        `Quest√£o <b>${atual+1}</b> de <b>${quiz.questoes.length}</b>`;

    document.getElementById("btnAvancar").style.display = "inline-block";

    atualizarBarra();

    let alternativas;

    if(!q.ordemExibida){

        alternativas = [
            {letra:"A", texto:q.ALT_A},
            {letra:"B", texto:q.ALT_B},
            {letra:"C", texto:q.ALT_C},
            {letra:"D", texto:q.ALT_D}
        ];

        alternativas = embaralharArray(alternativas);
        q.ordemExibida = alternativas;
        localStorage.setItem("quizAtual", JSON.stringify(quiz));

    }else{
        alternativas = q.ordemExibida;
    }

    document.getElementById("areaQuestao").innerHTML = `
        <div class="enunciado">
            <div class="questao-numero">
                Quest√£o ${atual+1}
            </div>
            <div class="questao-texto">
                ${q.ENUNCIADO}
            </div>
        </div>

        <div class="alternativas">
            ${alternativas.map((alt,i)=>`
                <label class="alt-item">
                    <input type="radio" name="resp" value="${alt.letra}">
                    <span>${String.fromCharCode(97+i)}) ${alt.texto}</span>
                </label>
            `).join("")}
        </div>
    `;

    const respAnterior = respostas.find(r => r.questao === q.ID);
    if(respAnterior){
        const radio = document.querySelector(
            `input[name="resp"][value="${respAnterior.marcada}"]`
        );
        if(radio) radio.checked = true;
    }

    if(atual === quiz.questoes.length-1){
        document.getElementById("btnAvancar").innerText = "Finalizar";
    }
}


// ===========================
function atualizarBarra(){
    const perc = ((atual) / quiz.questoes.length) * 100;
    document.getElementById("barra").style.width = perc + "%";
}


// ===========================
function atualizarCabecalho(){
    document.getElementById("infoAluno").innerHTML =
        `${quiz.alunoNome} ‚Ä¢ ${quiz.alunoTurma}`;
}


// ===========================
function avancar(){

    const marcada = document.querySelector('input[name="resp"]:checked');

    if(!marcada){
        mostrarAlerta("Selecione uma alternativa para continuar.");
        return;
    }

    respostas.push({
        questao: quiz.questoes[atual].ID,
        marcada: marcada.value,
        correta: quiz.questoes[atual].GABARITO
    });

    atual++;

    quiz.atual = atual;
    quiz.respostas = respostas;
    localStorage.setItem("quizAtual", JSON.stringify(quiz));

    if(atual >= quiz.questoes.length){
        finalizar();
        return;
    }

    mostrarQuestao();
}


// ===========================
// FINALIZAR
// ===========================
async function finalizar(){

    document.getElementById("btnAvancar").style.display = "none";

    if(enviando) return;
    enviando = true;
    
    mostrarOverlayEnvio();

    let acertos = respostas.filter(r=>r.marcada===r.correta).length;

    const envio = respostas.map(r => ({
        aplicacao: quiz.id,
        nomeQuiz: quiz.nome,
        aluno: quiz.alunoNome,
        turma: quiz.alunoTurma,
        questao: r.questao,
        marcada: r.marcada,
        correta: r.correta
    }));

    try {

        await fetch(API,{
            method:"POST",
            body: JSON.stringify({
                tipo:"respostas",
                payload: envio
            })
        });

        await fetch(API,{
    method:"POST",
    body: JSON.stringify({
        tipo:"respostas",
        payload: envio
    })
});

// üî• REMOVER OVERLAY AQUI
const overlay = document.getElementById("overlayEnvio");
if(overlay) overlay.remove();

localStorage.removeItem("quizAtual");

document.body.innerHTML = `
    <div class="final-card">
        <h2>üéâ Atividade Conclu√≠da!</h2>
        <p>Voc√™ acertou <b>${acertos}</b> de <b>${respostas.length}</b> quest√µes.</p>
        <p>Suas respostas foram registradas com sucesso.</p>
    </div>
`;
        
        localStorage.removeItem("quizAtual");

        document.body.innerHTML = `
            <div class="final-card">
                <h2>üéâ Atividade Conclu√≠da!</h2>
                <p>Voc√™ acertou <b>${acertos}</b> de <b>${respostas.length}</b> quest√µes.</p>
                <p>Suas respostas foram registradas com sucesso.</p>
            </div>
        `;

    } catch(e){
        enviando = false;
        mostrarAlerta("Erro ao enviar respostas. Verifique sua conex√£o.");
    }
}


// ===========================
// IDENTIFICA√á√ÉO
// ===========================
function iniciarIdentificacao(){

    if(quiz.alunoNome){
        mostrarQuestao();
        return;
    }

    const turmasPermitidas = quiz.turmas || [];

    document.body.innerHTML = `
        <div class="ident-page">

            <div class="ident-card">

                <h1 class="ident-titulo">${quiz.nome}</h1>

                <p class="ident-sub">
                    Informe seus dados para iniciar a atividade.
                </p>

                <div id="alertaQuiz" class="alerta" style="display:none;"></div>

                <div class="ident-campo">
                    <input id="nomeAluno"
                           placeholder="Digite seu nome completo">
                </div>

                <div class="ident-campo">
                    <select id="turmaAluno">
                        ${
                            turmasPermitidas.length === 0
                            ? `<option value="">Turma n√£o definida</option>`
                            : turmasPermitidas
                                .map(t=>`<option value="${t}">${t}</option>`)
                                .join("")
                        }
                    </select>
                </div>

                <button class="btn-iniciar"
                        onclick="confirmarAluno()">
                    Iniciar Atividade
                </button>

            </div>

        </div>
    `;
}

function confirmarAluno(){

    const nome = document.getElementById("nomeAluno").value.trim();
    const turma = document.getElementById("turmaAluno").value;

    if(!nome){
        mostrarAlerta("Por favor, informe seu nome para iniciar.");
        return;
    }

    quiz.alunoNome = nome;
    quiz.alunoTurma = turma;

    localStorage.setItem("quizAtual", JSON.stringify(quiz));
    location.reload();
}

function mostrarOverlayEnvio(){

  const overlay = document.createElement("div");
  overlay.className = "overlay-envio";
  overlay.id = "overlayEnvio";

  overlay.innerHTML = `
    <div class="overlay-box">
      <div class="overlay-spinner"></div>
      <h3>Registrando suas respostas...</h3>
      <p>Aguarde enquanto salvamos sua atividade.</p>
    </div>
  `;

  document.body.appendChild(overlay);
}    

</script>
</body>
</html>
