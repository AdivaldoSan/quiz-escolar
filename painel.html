<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Avalia+ | Painel do Professor</title>
<link rel="stylesheet" href="styles.css">
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<link rel="alternate icon" href="favicon.ico">
</head>

<body>

<script src="./js/conexao.js"></script>
<script src="./js/layout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>

function iniciarPagina(){
    criarLayout();

    document.getElementById("conteudo").innerHTML = `
        <h2 style="margin-bottom:20px;">ðŸ“Š Painel de AplicaÃ§Ãµes</h2>
        <div id="listaAplicacoes" class="card">
            Carregando aplicaÃ§Ãµes...
        </div>
    `;

    carregarAplicacoes();
}

window.onload = iniciarPagina;


// =============================
// CARREGAR
// =============================
async function carregarAplicacoes(){

    const token = localStorage.getItem("TOKEN");
    if(!token){
        window.location.href = "index.html";
        return;
    }

    const respAplicacoes =
        await fetch(API + "?tipo=listarAplicacoes&token=" + token);
    const dados = await respAplicacoes.json();

    if(!Array.isArray(dados) || dados.length <= 1){
        document.getElementById("listaAplicacoes").innerHTML =
            "Nenhuma aplicaÃ§Ã£o encontrada.";
        return;
    }

    const respContagem =
        await fetch(API + "?tipo=contarRespostas&token=" + token);
    const contagem = await respContagem.json();

    montarTabela(dados, contagem);
}


// =============================
// TABELA
// =============================
function montarTabela(dados, contagem){

    const linhas = dados.slice(1);

    let html = `
        <div class="table-wrapper">
        <table class="tabela">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Disciplina</th>
                <th>Data</th>
                <th class="text-center">Qtd. QuestÃµes</th>
                <th>Turmas</th>
                <th class="text-center">Respostas</th>
                <th class="text-center">AÃ§Ãµes</th>
                <th class="text-center">Ativo</th>
            </tr>
        </thead>
        <tbody>
    `;

    linhas.forEach(l=>{

        const id = l[0];

        
         let disciplina = "-";
        
                try {
        
                        const parametros = l[5] ? JSON.parse(l[5]) : null;
        
                            if(Array.isArray(parametros) && parametros.length > 0){
                            disciplina = parametros[0].DISCIPLINA || "-";
                    }
        
        } catch(e){
            disciplina = "-";
        }
        
        const totalRespostas = contagem[id] || 0;
        const turmas = l[6] ? JSON.parse(l[6]) : [];
        const status = l[7];
        const linkRelatorio = l[8];

        const dataFormatada =
            new Date(l[3]).toLocaleDateString("pt-BR");

        const linkAluno =
            window.location.origin +
            window.location.pathname.replace(
                "painel.html",
                "aluno.html?id="+id
            );

        html += `
            <tr>
                <td>${l[1]}</td>
                <td>${disciplina}</td>
                <td>${dataFormatada}</td>
                <td class="text-center">${l[4]}</td>
                <td>${turmas.join(", ")}</td>
                <td class="text-center">${totalRespostas}</td>

                <td class="text-center">
                    <div class="acoes">

                        ${
                            totalRespostas > 0
                            ? `<button class="btn-acao"
                                       title="RelatÃ³rio"
                                       onclick="abrirRelatorio('${id}','${linkRelatorio || ""}')">
                                       ðŸ“Š
                               </button>`
                            : "â€”"
                        }

                        <button class="btn-acao"
                                title="Prova"
                                onclick="gerarPDF('${id}')">
                                ðŸ“„
                        </button>

                        <button class="btn-acao"
                                title="Gabarito"
                                onclick="gerarGabarito('${id}')">
                                ðŸ“‘
                        </button>

                        <button class="btn-acao"
                                title="Copiar link para os alunos"
                                onclick="copiarLink('${linkAluno}')">
                                ðŸ”—
                        </button>

                        <button class="btn-acao"
                                title="QR CODE"
                                onclick="abrirQRCode('${id}')">
                                ðŸ“±
                        </button>

                    </div>
                </td>

                <td class="text-center">
                    <label class="switch">
                        <input type="checkbox"
                               ${status==="SIM"?"checked":""}
                               onchange="alterarStatus('${id}', this.checked)">
                        <span class="slider"></span>
                    </label>
                </td>

            </tr>
        `;
    });

    html += "</tbody></table></div>";

    document.getElementById("listaAplicacoes").innerHTML = html;
}


// =============================
// COPIAR LINK
// =============================
function copiarLink(link){

    navigator.clipboard.writeText(link)
    .then(()=>{
        mostrarToast("Link copiado com sucesso!");
    })
    .catch(()=>{
        mostrarToast("NÃ£o foi possÃ­vel copiar o link.");
    });

}


// =============================
// GERAR PDF DA PROVA
// =============================
async function gerarPDF(id){

    const novaJanela = window.open("", "_blank");

    if(!novaJanela){
        alert("Permita popups para gerar a prova.");
        return;
    }

    try{

        const resp = await fetch(API+"?tipo=abrirAplicacao&id="+id);
        const dados = await resp.json();

        if(dados.erro){
            novaJanela.close();
            alert("Erro ao carregar aplicaÃ§Ã£o.");
            return;
        }

        novaJanela.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <base href="${window.location.origin}/">
                    <title>Prova</title>
                    <style>
                        body{
                            font-family: Arial;
                            margin: 50px;
                        }
                
                        .cabecalho{
                            display:flex;
                            align-items:center;
                            gap:15px;
                            margin-bottom:30px;
                        }
                
                        .cabecalho img{
                            height:50px;
                        }
                
                        .titulo-sistema{
                            font-size:18px;
                            font-weight:bold;
                        }
                
                        .subtitulo{
                            font-size:14px;
                            color:#555;
                        }
                
                        h2{
                            text-align:center;
                            margin-bottom:20px;
                        }
                
                        .questao{
                            margin-bottom:25px;
                        }
                    </style>
                </head>
                <body>
                
                <div class="cabecalho">
                    <img src="https://adivaldosan.github.io/quiz-escolar/favicon.svg">
                    <div>
                        <div class="titulo-sistema">Avalia+</div>
                        <div class="subtitulo">Plataforma de AvaliaÃ§Ã£o Digital</div>
                    </div>
                </div>
                
                <h2>${dados.nome}</h2>
                <p>Escola ___________________________________________</p>
                <p>Aluno  ___________________________________________</p>
                <p>SÃ©rie _________Turma_________</p>
                <hr>
                        `);

        dados.questoes.forEach((q,i)=>{

            novaJanela.document.write(`
                <div class="questao">
                    <b>${i+1}) ${q.ENUNCIADO}</b><br><br>
                    A) ${q.ALT_A}<br>
                    B) ${q.ALT_B}<br>
                    C) ${q.ALT_C}<br>
                    D) ${q.ALT_D}<br>
                </div>
            `);

        });

        novaJanela.document.write(`
</body>
</html>
        `);

     novaJanela.document.close();

            let imprimiu = false;
            
            function imprimir(){
                if(imprimiu) return;
                imprimiu = true;
                novaJanela.focus();
                novaJanela.print();
            }
            
            const img = novaJanela.document.querySelector("img");
            
            if(img){
            
                img.onload = imprimir;
                img.onerror = imprimir;
            
                setTimeout(imprimir, 1000);
            
            }else{
            
                imprimir();
            }

    }catch(e){

        novaJanela.close();
        alert("Erro ao gerar prova.");
    }
}

// =============================
// GERAR GABARITO
// =============================
async function gerarGabarito(id){

    const novaJanela = window.open("", "_blank");

    if(!novaJanela){
        alert("Permita popups para gerar o gabarito.");
        return;
    }

    try{

        const resp = await fetch(API+"?tipo=abrirAplicacao&id="+id);
        const dados = await resp.json();

        if(dados.erro){
            novaJanela.close();
            alert("Erro ao carregar aplicaÃ§Ã£o.");
            return;
        }

        novaJanela.document.write(`
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gabarito</title>
<style>
    body{
        font-family: Arial;
        margin: 50px;
    }

    .cabecalho{
        display:flex;
        align-items:center;
        gap:15px;
        margin-bottom:30px;
    }

    .cabecalho img{
        height:50px;
    }

    .titulo-sistema{
        font-size:18px;
        font-weight:bold;
    }

    .subtitulo{
        font-size:14px;
        color:#555;
    }

    h2{
        text-align:center;
        margin-bottom:20px;
    }

    .linha-gabarito{
        margin-bottom:8px;
        font-size:15px;
    }
</style>
</head>
<body>

<div class="cabecalho">
    <img src="https://adivaldosan.github.io/quiz-escolar/favicon.svg">
    <div>
        <div class="titulo-sistema">Avalia+</div>
        <div class="subtitulo">Plataforma de AvaliaÃ§Ã£o Digital</div>
    </div>
</div>

<h2>Gabarito â€“ ${dados.nome}</h2>
<hr>
        `);

        dados.questoes.forEach((q,i)=>{

            novaJanela.document.write(`
                <div class="linha-gabarito">
                    ${i+1}) ${q.GABARITO}
                </div>
            `);

        });

        novaJanela.document.write(`
</body>
</html>
        `);

        novaJanela.document.close();

            let imprimiu = false;
            
            function imprimir(){
                if(imprimiu) return;
                imprimiu = true;
                novaJanela.focus();
                novaJanela.print();
            }
            
            const img = novaJanela.document.querySelector("img");
            
            if(img){
            
                img.onload = imprimir;
                img.onerror = imprimir;
            
                setTimeout(imprimir, 1000);
            
            }else{
            
                imprimir();
            }
            
    }catch(e){

        novaJanela.close();
        alert("Erro ao gerar gabarito.");
    }
}

// =============================
// ABRIR RELATÃ“RIO
// =============================
async function abrirRelatorio(id, linkExistente){

    const novaJanela = window.open("", "_blank");

    if(!novaJanela){
        alert("Permita popups para abrir relatÃ³rio.");
        return;
    }

    try{

        let linkFinal = linkExistente;

        if(!linkFinal || !linkFinal.startsWith("http")){

            const token = localStorage.getItem("TOKEN");

            const resp = await fetch(
                API + "?tipo=gerarRelatorio&id=" + id + "&token=" + token
            );

            const dados = await resp.json();

            if(dados.erro){
                novaJanela.close();
                alert("Erro ao gerar relatÃ³rio: " + dados.erro);
                return;
            }

            linkFinal = dados.link;
        }

        novaJanela.location.href = linkFinal;

    }catch(e){
        novaJanela.close();
        alert("Erro ao abrir relatÃ³rio.");
    }
}


// =============================
// ALTERAR STATUS
// =============================
async function alterarStatus(id, status){

    const token = localStorage.getItem("TOKEN");

    const resp = await fetch(API, {
        method:"POST",
        body: JSON.stringify({
            tipo:"alterarStatus",
            token: token,
            id: id,
            status: status
        })
    });

    const retorno = await resp.json();

    if(retorno.erro){
        alert("Erro: " + retorno.erro);
        return;
    }

carregarAplicacoes();
}

function abrirQRCode(id){

    const link = window.location.origin +
                 window.location.pathname.replace("painel.html","") +
                 "aluno.html?id=" + id;

    const modal = document.createElement("div");
    modal.id = "modalQR";

    modal.innerHTML = `
        <div class="modal-bg" onclick="fecharQR()"></div>
        <div class="modal-box">
            <h3>AplicaÃ§Ã£o via QR Code</h3>

            <div id="qrcode"></div>

            <input value="${link}" readonly onclick="this.select()">

            <button onclick="fecharQR()">Fechar</button>
        </div>
    `;

    document.body.appendChild(modal);

    new QRCode(document.getElementById("qrcode"), {
        text: link,
        width: 180,
        height: 180
    });
}

function fecharQR(){
    const modal = document.getElementById("modalQR");
    if(modal) modal.remove();
}


function mostrarToast(mensagem){

    const toast = document.createElement("div");
    toast.className = "toast";
    toast.innerText = mensagem;

    document.body.appendChild(toast);

    // forÃ§a reflow para animar
    setTimeout(() => toast.classList.add("show"), 10);

    // remover apÃ³s 3s
    setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
    
carregarAplicacoes();

</script>

</body>
</html>
