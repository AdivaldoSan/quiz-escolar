<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel do Professor</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>

<script src="./js/conexao.js"></script>
<script src="./js/layout.js"></script>

<script>

function iniciarPagina(){
    criarLayout();

    document.getElementById("conteudo").innerHTML = `
        <h2 style="margin-bottom:20px;">ðŸ“Š Painel de AplicaÃ§Ãµes</h2>
        <div id="listaAplicacoes" class="card">
            Carregando aplicaÃ§Ãµes...
        </div>
    `;

    carregarAplicacoes();
}

window.onload = iniciarPagina;


// =============================
// CARREGAR APLICAÃ‡Ã•ES
// =============================
async function carregarAplicacoes(){

    try{

        const token = localStorage.getItem("TOKEN");

        if(!token){
            window.location.href = "index.html";
            return;
        }

        const respAplicacoes = await fetch(
            API + "?tipo=listarAplicacoes&token=" + token
        );

        const dados = await respAplicacoes.json();

        if(dados.erro){
            document.getElementById("listaAplicacoes").innerHTML =
                "Erro: " + dados.erro;
            return;
        }

        if(!Array.isArray(dados) || dados.length <= 1){
            document.getElementById("listaAplicacoes").innerHTML =
                "Nenhuma aplicaÃ§Ã£o encontrada.";
            return;
        }

        const respContagem = await fetch(
            API + "?tipo=contarRespostas&token=" + token
        );

        const contagem = await respContagem.json();

        montarTabela(dados, contagem);

    }catch(e){

        console.error("Erro:", e);

        document.getElementById("listaAplicacoes").innerHTML =
            "Erro de conexÃ£o com o servidor.";
    }
}


// =============================
// MONTAR TABELA
// =============================
function montarTabela(dados, contagem){

    const linhas = dados.slice(1);

    let html = `
        <div class="table-wrapper">
        <table class="tabela">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Data</th>
                <th>Qtd</th>
                <th>Turmas</th>
                <th>Respostas</th>
                <th>AÃ§Ãµes</th>
                <th>Ativo</th>
            </tr>
        </thead>
        <tbody>
    `;

    linhas.forEach(l=>{

        const id = l[0];
        const totalRespostas = contagem[id] || 0;
        const turmas = l[6] ? JSON.parse(l[6]) : [];
        const status = l[7];
        const linkRelatorio = l[8];

        html += `
            <tr>
                <td>${l[1]}</td>
                <td>${new Date(l[3]).toLocaleString()}</td>
                <td>${l[4]}</td>
                <td>${turmas.join(", ")}</td>
                <td>${totalRespostas}</td>

                <td>
                    <div class="acoes">
                        ${
                            totalRespostas > 0
                            ? `<button class="btn-acao"
                                       title="Abrir relatÃ³rio de desempenho"
                                       onclick="abrirRelatorio('${id}', '${linkRelatorio || ""}')">
                                       ðŸ“Š
                               </button>`
                            : "â€”"
                        }

                        <button class="btn-acao"
                                title="Gerar versÃ£o impressa da prova"
                                onclick="gerarPDF('${id}')">
                                ðŸ“„
                        </button>

                        <button class="btn-acao"
                                title="Gerar gabarito para impressÃ£o"
                                onclick="gerarGabarito('${id}')">
                                ðŸ“‘
                        </button>
                    </div>
                </td>

                <td>
                    <select class="select-status"
                        title="Definir se a aplicaÃ§Ã£o estÃ¡ ativa para os alunos"
                        onchange="alterarStatus('${id}', this.value)">
                        <option value="SIM" ${status==="SIM"?"selected":""}>SIM</option>
                        <option value="NAO" ${status==="NAO"?"selected":""}>NÃƒO</option>
                    </select>
                </td>
            </tr>
        `;
    });

    html += "</tbody></table></div>";

    document.getElementById("listaAplicacoes").innerHTML = html;
}


// =============================
// GERAR PDF
// =============================
async function gerarPDF(id){

    const novaJanela = window.open("", "_blank");
    if(!novaJanela){
        alert("Permita popups para gerar o PDF.");
        return;
    }

    novaJanela.document.write("<p>Carregando prova...</p>");

    try{

        const resp = await fetch(API+"?tipo=abrirAplicacao&id="+id);
        const dados = await resp.json();

        if(dados.erro){
            novaJanela.close();
            alert("Erro ao carregar aplicaÃ§Ã£o.");
            return;
        }

        novaJanela.document.body.innerHTML = `
            <style>
                body{font-family:Arial;margin:50px;}
                h2{text-align:center;}
                .questao{margin-bottom:25px;}
            </style>

            <h2>${dados.nome}</h2>
            <p>Aluno: ___________________________________________</p>
            <hr>

            ${
                dados.questoes.map((q,i)=>`
                    <div class="questao">
                        <b>${i+1}) ${q.ENUNCIADO}</b><br><br>
                        A) ${q.ALT_A}<br>
                        B) ${q.ALT_B}<br>
                        C) ${q.ALT_C}<br>
                        D) ${q.ALT_D}<br>
                    </div>
                `).join("")
            }
        `;

        novaJanela.document.close();
        novaJanela.print();

    }catch(e){
        novaJanela.close();
        alert("Erro ao gerar PDF.");
    }
}


// =============================
// GERAR GABARITO
// =============================
async function gerarGabarito(id){

    const novaJanela = window.open("", "_blank");
    if(!novaJanela){
        alert("Permita popups.");
        return;
    }

    try{

        const resp = await fetch(API+"?tipo=abrirAplicacao&id="+id);
        const dados = await resp.json();

        if(dados.erro){
            novaJanela.close();
            alert("Erro ao carregar aplicaÃ§Ã£o.");
            return;
        }

        novaJanela.document.body.innerHTML = `
            <style>
                body{font-family:Arial;margin:50px;}
            </style>

            <h2>Gabarito â€“ ${dados.nome}</h2>
            <hr>

            ${
                dados.questoes.map((q,i)=>`
                    ${i+1}) ${q.GABARITO}<br>
                `).join("")
            }
        `;

        novaJanela.document.close();
        novaJanela.print();

    }catch(e){
        novaJanela.close();
        alert("Erro ao gerar gabarito.");
    }
}


// =============================
// RELATÃ“RIO
// =============================
async function abrirRelatorio(id, linkExistente){

    const novaJanela = window.open("", "_blank");
    if(!novaJanela){
        alert("Permita popups.");
        return;
    }

    try{

        let linkFinal = linkExistente;

        if(!linkFinal || !linkFinal.startsWith("http")){

            const token = localStorage.getItem("TOKEN");

            const resp = await fetch(
                API + "?tipo=gerarRelatorio&id=" + id + "&token=" + token
            );

            const dados = await resp.json();

            if(dados.erro){
                novaJanela.close();
                alert("Erro ao gerar relatÃ³rio: " + dados.erro);
                return;
            }

            linkFinal = dados.link;
        }

        novaJanela.location.href = linkFinal;

    }catch(e){
        novaJanela.close();
        alert("Erro ao abrir relatÃ³rio.");
    }
}


// =============================
// ALTERAR STATUS
// =============================
async function alterarStatus(id, status){

    const token = localStorage.getItem("TOKEN");

    const resp = await fetch(API, {
        method:"POST",
        body: JSON.stringify({
            tipo:"alterarStatus",
            token: token,
            id: id,
            status: status
        })
    });

    const retorno = await resp.json();

    if(retorno.erro){
        alert("Erro: " + retorno.erro);
        return;
    }

    carregarAplicacoes();
}

</script>

</body>
</html>
