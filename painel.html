<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Painel do Professor</title>
</head>

<body style="font-family:Arial; max-width:1000px; margin:auto;">

<h2>ðŸ“Š Painel de AplicaÃ§Ãµes</h2>

<div id="conteudo">Carregando aplicaÃ§Ãµes...</div>

<script src="./js/conexao.js"></script>

<script>

const professorEmail = "professoradivaldo@gmail.com";

async function carregarAplicacoes(){

    const [respAplicacoes, respContagem] = await Promise.all([
        fetch(API + "?tipo=listarAplicacoes&professor=" + professorEmail),
        fetch(API + "?tipo=contarRespostas")
    ]);

    const dados = await respAplicacoes.json();
    const contagem = await respContagem.json();

    if(dados.erro){
        document.getElementById("conteudo").innerText =
            "Erro ao carregar aplicaÃ§Ãµes.";
        return;
    }

    if(dados.length <= 1){
        document.getElementById("conteudo").innerText =
            "Nenhuma aplicaÃ§Ã£o encontrada.";
        return;
    }

    montarTabela(dados, contagem);
}

function montarTabela(dados, contagem){

    const linhas = dados.slice(1);

    let html = `
        <table border="1" cellpadding="8" cellspacing="0" width="100%">
        <tr style="background:#f0f0f0;">
            <th>ID</th>
            <th>Nome</th>
            <th>Data</th>
            <th>Qtd</th>
            <th>Respostas</th>
            <th>RelatÃ³rio</th>
            <th>Ativa</th>
        </tr>
    `;

    linhas.forEach(l=>{

        linhas.forEach(l=>{

    const id = l[0];
    const totalRespostas = contagem[id] || 0;
    const linkRelatorio = l[5]; // coluna PARAMETROS

    html += `
        <tr>
            <td>${id}</td>
            <td>${l[1]}</td>
            <td>${l[3]}</td>
            <td>${l[4]}</td>
            <td>${totalRespostas}</td>
            <td>
                <button onclick="abrirRelatorio('${id}', '${linkRelatorio || ""}')">
                    ðŸ“¥ RelatÃ³rio
                </button>
            </td>
            <td>${l[6]}</td>
        </tr>
    `;
});

    html += "</table>";

    document.getElementById("conteudo").innerHTML = html;
}

carregarAplicacoes();

    async function abrirRelatorio(id, linkExistente){

    if(linkExistente && linkExistente.startsWith("http")){
        window.open(linkExistente, "_blank");
        return;
    }

    const resp = await fetch(
        API + "?tipo=gerarRelatorio&id=" + id
    );

    const dados = await resp.json();

    if(dados.erro){
        alert("Erro ao gerar relatÃ³rio.");
        return;
    }

    window.open(dados.link, "_blank");

    // Atualiza pÃ¡gina para mostrar link salvo
    setTimeout(()=>location.reload(), 1000);
}

</script>

</body>
</html>
