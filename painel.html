<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Painel do Professor</title>
</head>

<body style="font-family:Arial; max-width:1000px; margin:auto;">

<h2>üìä Painel de Aplica√ß√µes</h2>

<div id="conteudo">Carregando aplica√ß√µes...</div>

<script src="./js/conexao.js"></script>

<script>


async function carregarAplicacoes(){

    try{

        const respAplicacoes = await fetch(
            API + "?tipo=listarAplicacoes"
        );

        //const dados = await respAplicacoes.json();

        const dados = await respAplicacoes.json();
        console.log("RETORNO APLICACOES:", dados);
        console.log("TIPO:", typeof dados);
        console.log("IS ARRAY:", Array.isArray(dados));

        const respContagem = await fetch(
            API + "?tipo=contarRespostas"
        );

        const contagem = await respContagem.json();

        if(!Array.isArray(dados)){
        document.getElementById("conteudo").innerText =
        "Erro ao carregar aplica√ß√µes.";
        console.log("Resposta inesperada:", dados);
        return;
}

        if(dados.length <= 1){
        document.getElementById("conteudo").innerText =
        "Nenhuma aplica√ß√£o encontrada.";
        return;
}

        montarTabela(dados, contagem);

    }catch(e){

        document.getElementById("conteudo").innerText =
            "Erro de conex√£o com o servidor.";
    }
}


// =============================
// MONTAR TABELA
// =============================
function montarTabela(dados, contagem){

    const linhas = dados.slice(1);

    let html = `
        <table border="1" cellpadding="8" cellspacing="0" width="100%">
        <tr style="background:#f0f0f0;">
            <th>ID</th>
            <th>Nome</th>
            <th>Data</th>
            <th>Qtd</th>
            <th>Respostas</th>
            <th>Relat√≥rio</th>
            <th>Ativa</th>
        </tr>
    `;

    linhas.forEach(l=>{

        const id = l[0];
        const totalRespostas = contagem[id] || 0;
        const linkRelatorio = l[8]; // LINK_RELATORIO

        html += `
            <tr>
                <td>${id}</td>
                <td>${l[1]}</td>
                <td>${l[3]}</td>
                <td>${l[4]}</td>
                <td>${totalRespostas}</td>
                <td>
                    ${
                        totalRespostas > 0
                        ? `<button onclick="abrirRelatorio('${id}', '${linkRelatorio || ""}')">
                               üì• Relat√≥rio
                           </button>`
                        : "‚Äî"
                    }
                </td>
                <td>
                <select onchange="alterarStatus('${id}', this.value)">
                <option value="SIM" ${l[7]==="SIM"?"selected":""}>SIM</option>
                <option value="NAO" ${l[7]==="NAO"?"selected":""}>N√ÉO</option>
                </select>
                </td>
            </tr>
        `;
    });

    html += "</table>";

    document.getElementById("conteudo").innerHTML = html;
}


// =============================
// ABRIR OU GERAR RELAT√ìRIO
// =============================
async function abrirRelatorio(id, linkExistente){

    let linkFinal = linkExistente;

    if(!linkFinal || !linkFinal.startsWith("http")){

        const resp = await fetch(
            API + "?tipo=gerarRelatorio&id=" + id
        );

        const dados = await resp.json();

        if(dados.erro){
            alert("Erro ao gerar relat√≥rio.");
            return;
        }

        linkFinal = dados.link;
    }

    // abre sem bloqueio
    const a = document.createElement("a");
    a.href = linkFinal;
    a.target = "_blank";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // opcional: remover reload autom√°tico
}
    async function alterarStatus(id, status){

    await fetch(API, {
        method:"POST",
        body: JSON.stringify({
            tipo:"alterarStatus",
            id:id,
            status:status
        })
    });

}

carregarAplicacoes();

</script>

</body>
</html>
