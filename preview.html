<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Avalia+ | Pr√©-visualiza√ß√£o</title>
<link rel="stylesheet" href="styles.css">
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<link rel="alternate icon" href="favicon.ico">
</head>

<body>

<script src="./js/conexao.js"></script>
<script src="./js/layout.js"></script>

<!-- Biblioteca QR Code (leve) -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>

let publicado = false;

function iniciarPagina(){

    criarLayout();

    const preview = JSON.parse(localStorage.getItem("previewQuiz"));

    if(!preview){
        document.getElementById("conteudo").innerHTML =
            "<h3>Preview n√£o encontrado.</h3>";
        return;
    }

    document.getElementById("conteudo").innerHTML = `
        <h2 style="margin-bottom:20px;">üìã Pr√©-visualiza√ß√£o das Quest√µes...</h2>

        <div class="card">

            <div class="preview-info">
                <p><strong>Nome:</strong> ${preview.nome}</p>
                <p><strong>Turmas:</strong> ${preview.turmas.join(", ")}</p>
                <p><strong>Quantidade:</strong> ${preview.qtd} quest√µes</p>
            </div>

            <hr style="margin:20px 0;">

            <div id="listaQuestoes"></div>

            <div id="areaPublicacao" style="margin-top:25px;">
                <button class="btn-primary"
                        id="btnPublicar"
                        onclick="publicar()">
                    Publicar Aplica√ß√£o
                </button>
            </div>

        </div>
    `;

    const container = document.getElementById("listaQuestoes");

    preview.questoes.forEach((q,i)=>{

    const div = document.createElement("div");
    div.className = "preview-questao";

    function alt(letra, texto){
        const correta = (letra === q.GABARITO);
        return `
            <div class="alt-preview ${correta ? "alt-correta" : ""}">
                ${correta ? "‚úî " : ""}
                <strong>${letra})</strong> ${texto}
            </div>
        `;
    }

    div.innerHTML = `
        <strong>${i+1}) ${q.ENUNCIADO}</strong><br><br>
        ${alt("A", q.ALT_A)}
        ${alt("B", q.ALT_B)}
        ${alt("C", q.ALT_C)}
        ${alt("D", q.ALT_D)}
    `;

    container.appendChild(div);
});
}

window.onload = iniciarPagina;


// =========================
// PUBLICAR
// =========================
async function publicar(){

    if(publicado) return;
    publicado = true;

    const btn = document.getElementById("btnPublicar");

    btn.disabled = true;
    btn.innerHTML = `<div class="loader"></div>`;

    const preview =
        JSON.parse(localStorage.getItem("previewQuiz"));

    try{

        const resposta = await fetch(API, {
            method:"POST",
            body: JSON.stringify({
                tipo:"aplicacao",
                token: localStorage.getItem("TOKEN"),
                id: preview.id,
                nome: preview.nome,
                qtd: preview.qtd,
                questoes: preview.questoes,
                turmas: preview.turmas
            })
        });

        const retorno = await resposta.json();

        if(retorno.erro){
            throw new Error(retorno.erro);
        }

        const link = window.location.href
            .replace("preview.html",
                     "aluno.html?id="+preview.id);

        // Remove bot√£o
        document.getElementById("areaPublicacao").innerHTML = `
        <div class="publicado-box">

        <h3 style="margin-bottom:10px;">
            Aplica√ß√£o publicada ‚úî
        </h3>

        <div class="link-box">
            <input id="link"
                   value="${link}"
                   readonly>
            <button onclick="copiar()">Copiar</button>
        </div>

        <div id="qrcode" style="margin-top:20px;"></div>

        <div class="instrucao-impressao">
            üìå Para gerar a vers√£o impressa
            (prova e gabarito),
            acesse o menu <strong>Painel</strong>
            no lado esquerdo.
        </div>

    </div>
`;

        // Gerar QR Code
        new QRCode(document.getElementById("qrcode"), {
            text: link,
            width: 180,
            height: 180
        });

        localStorage.removeItem("previewQuiz");

    }catch(e){

        publicado = false;
        btn.disabled = false;
        btn.innerText = "Publicar Aplica√ß√£o";

        alert("Erro ao publicar: " + e.message);
    }
}


// =========================
// COPIAR LINK
// =========================
function copiar(){

    const input = document.getElementById("link");
    input.select();
    document.execCommand("copy");
}

</script>

</body>
</html>
