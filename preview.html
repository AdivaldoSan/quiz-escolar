<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pr√©-visualiza√ß√£o</title>
</head>

<body style="font-family:Arial; max-width:900px; margin:auto;">

<h2>üìã Pr√©-visualiza√ß√£o do Quiz</h2>

<div id="conteudo"></div>

<br>
<button id="btnPublicar" onclick="publicar()">Publicar Aplica√ß√£o</button>

<p id="status"></p>

<script src="./js/conexao.js"></script>

<script>


let publicado = false;

// =========================
// CARREGA QUIZ TEMPOR√ÅRIO
// =========================
const preview = JSON.parse(localStorage.getItem("previewQuiz"));

if(!preview){
    document.body.innerHTML = "<h3>Preview n√£o encontrado.</h3>";
    throw new Error("previewQuiz n√£o existe");
}

// =========================
// MOSTRA INFORMA√á√ïES
// =========================
document.getElementById("conteudo").innerHTML = `
<b>Nome:</b> ${preview.nome}<br>
<b>Turmas:</b> ${preview.turmas.join(", ")}<br>
<b>Quantidade:</b> ${preview.qtd} quest√µes<br>
<hr>
`;

// =========================
// LISTA QUEST√ïES
// =========================
preview.questoes.forEach((q,i)=>{
    const div = document.createElement("div");
    div.style.marginBottom = "18px";

    div.innerHTML = `
        <b>${i+1}) ${q.ENUNCIADO}</b><br>
        A) ${q.ALT_A}<br>
        B) ${q.ALT_B}<br>
        C) ${q.ALT_C}<br>
        D) ${q.ALT_D}<br>
    `;

    document.getElementById("conteudo").appendChild(div);
});


// =========================
// PUBLICAR (SALVA NO BACKEND)
// =========================
async function publicar(){

    if(publicado) return;
    publicado = true;

    const btn = document.getElementById("btnPublicar");
    btn.disabled = true;
    btn.innerText = "Publicando...";

    document.getElementById("status").innerText = "Registrando aplica√ß√£o...";

    try{

        const resposta = await fetch(API, {
            method:"POST",
            body: JSON.stringify({
                tipo:"aplicacao",
                id:preview.id,
                nome:preview.nome,
                email:preview.professor,
                qtd:preview.qtd,
                questoes:preview.questoes,
                turmas:preview.turmas   // ‚úÖ agora envia array correto
            })
        });

        const retorno = await resposta.json();

        if(retorno.erro){
            throw new Error(retorno.erro);
        }

        const link = window.location.href
            .replace("preview.html","aluno.html?id="+preview.id);

        document.getElementById("status").innerHTML = `
            ‚úÖ Aplica√ß√£o publicada!<br><br>
            <b>Link para os alunos:</b><br>
            <input id="link" value="${link}" style="width:100%;padding:6px"><br><br>
            <button onclick="copiar()">üìã Copiar Link</button>
        `;

        localStorage.removeItem("previewQuiz");

    }catch(e){

        publicado = false;
        btn.disabled = false;
        btn.innerText = "Publicar Aplica√ß√£o";

        alert("Erro ao publicar: " + e.message);
    }
}


// =========================
// COPIAR LINK
// =========================
function copiar(){

    const input = document.getElementById("link");
    input.select();
    document.execCommand("copy");

    alert("Link copiado!");
}

</script>

</body>
</html>
