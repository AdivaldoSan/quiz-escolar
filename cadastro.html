<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cadastro - Sistema Web Quiz</title>
</head>

<body style="font-family: Arial; max-width:500px; margin:auto; margin-top:40px;">

<h2>ðŸ“‹ Primeiro Acesso</h2>

<input type="text" id="nome" placeholder="Nome completo" required style="padding:8px;width:100%"><br><br>

<input type="email" id="email" placeholder="Email" required style="padding:8px;width:100%"><br><br>

<input type="password" id="senha" placeholder="Senha" required style="padding:8px;width:100%"><br><br>

<input type="text" id="escola" placeholder="Escola" required style="padding:8px;width:100%"><br><br>

<select id="estado" required style="padding:8px;width:100%" onchange="verificarEstado()">
  <option value="">Selecione o Estado</option>
  <option value="RO">RO</option>
  <option value="AC">AC</option>
  <option value="AM">AM</option>
  <option value="AP">AP</option>
  <option value="BA">BA</option>
  <option value="CE">CE</option>
  <option value="DF">DF</option>
  <option value="ES">ES</option>
  <option value="GO">GO</option>
  <option value="MA">MA</option>
  <option value="MG">MG</option>
  <option value="MS">MS</option>
  <option value="MT">MT</option>
  <option value="PA">PA</option>
  <option value="PB">PB</option>
  <option value="PE">PE</option>
  <option value="PI">PI</option>
  <option value="PR">PR</option>
  <option value="RJ">RJ</option>
  <option value="RN">RN</option>
  <option value="RS">RS</option>
  <option value="RR">RR</option>
  <option value="SC">SC</option>
  <option value="SE">SE</option>
  <option value="SP">SP</option>
  <option value="TO">TO</option>
</select><br><br>

<div id="cidadeContainer">
  <input type="text" id="cidadeManual" placeholder="Cidade" required style="padding:8px;width:100%">
</div><br>

<select id="disciplina" required style="padding:8px;width:100%">
  <option value="">Selecione a Disciplina</option>
  <option value="MatemÃ¡tica">MatemÃ¡tica</option>
  <option value="PortuguÃªs">PortuguÃªs</option>
  <option value="FÃ­sica">FÃ­sica</option>
  <option value="QuÃ­mica">QuÃ­mica</option>
  <option value="Biologia">Biologia</option>
  <option value="HistÃ³ria">HistÃ³ria</option>
  <option value="Geografia">Geografia</option>
  <option value="InglÃªs">InglÃªs</option>
  <option value="Outra">Outra</option>
</select><br><br>

<button onclick="cadastrar()" style="padding:10px 20px;">Cadastrar</button>

<p id="msg" style="margin-top:20px;"></p>

<script src="./js/conexao.js"></script>

<script>

async function verificarEstado(){

  const estado = document.getElementById("estado").value;
  const container = document.getElementById("cidadeContainer");

  if(estado === "RO"){

    container.innerHTML = `<select id="cidadeSelect" required style="padding:8px;width:100%">
      <option>Carregando cidades...</option>
    </select>`;

    try{

      const resp = await fetch(
        "https://servicodados.ibge.gov.br/api/v1/localidades/estados/RO/municipios"
      );

      const cidades = await resp.json();

      const select = document.getElementById("cidadeSelect");
      select.innerHTML = `<option value="">Selecione a Cidade</option>`;

      cidades.sort((a,b)=>a.nome.localeCompare(b.nome));

      cidades.forEach(c=>{
        select.innerHTML += `<option value="${c.nome}">${c.nome}</option>`;
      });

    }catch(e){

      container.innerHTML = `
        <input type="text" id="cidadeManual"
        placeholder="Cidade"
        required style="padding:8px;width:100%">
      `;
    }

  }else{

    container.innerHTML = `
      <input type="text" id="cidadeManual"
      placeholder="Cidade"
      required style="padding:8px;width:100%">
    `;
  }
}


async function cadastrar(){

  const nome = document.getElementById("nome").value.trim();
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const escola = document.getElementById("escola").value.trim();
  const estado = document.getElementById("estado").value;
  const disciplina = document.getElementById("disciplina").value;

  let cidade = "";

  if(estado === "RO"){
    cidade = document.getElementById("cidadeSelect").value;
  }else{
    cidade = document.getElementById("cidadeManual").value.trim();
  }

  if(!nome || !email || !senha || !escola || !estado || !cidade || !disciplina){
    document.getElementById("msg").innerText =
      "Preencha todos os campos.";
    return;
  }

  const resposta = await fetch(API, {
    method: "POST",
    body: JSON.stringify({
      tipo:"cadastro",
      nome:nome,
      email:email,
      senha:senha,
      escola:escola,
      cidade:cidade,
      estado:estado,
      disciplina:disciplina
    })
  });

  const dados = await resposta.json();

  if(dados.mensagem){
    document.getElementById("msg").innerText =
      "Cadastro realizado. Aguarde aprovaÃ§Ã£o do administrador.";
  }else{
    document.getElementById("msg").innerText =
      dados.erro || "Erro no cadastro.";
  }
}

</script>

</body>
</html>
