<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro - Avalia+</title>
<link rel="stylesheet" href="styles.css">
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<link rel="alternate icon" href="favicon.ico">
</head>

<body class="login-page">

<div class="login-box">

<h2>üìã Primeiro Acesso</h2>

<div class="form-group">
<input type="text" id="nome" placeholder="Nome completo">
</div>

<div class="form-group">
<input type="email" id="email" placeholder="Email institucional">
</div>

<div class="form-group">
<input type="password" id="senha" placeholder="Senha">
</div>

<div class="form-group">
<input type="text" id="escola" placeholder="Escola">
</div>

<div class="form-group">
<select id="estado" onchange="verificarEstado()">
<option value="">Selecione o Estado</option>
<option value="RO">RO</option>
<option value="AC">AC</option>
<option value="AM">AM</option>
<option value="BA">BA</option>
<option value="CE">CE</option>
<option value="DF">DF</option>
<option value="ES">ES</option>
<option value="GO">GO</option>
<option value="MG">MG</option>
<option value="MT">MT</option>
<option value="PA">PA</option>
<option value="PR">PR</option>
<option value="RJ">RJ</option>
<option value="RS">RS</option>
<option value="SC">SC</option>
<option value="SP">SP</option>
</select>
</div>

<div class="form-group" id="cidadeContainer">
<input type="text" id="cidadeManual" placeholder="Cidade">
</div>

<div class="form-group">
<select id="disciplina">
<option value="">Selecione a Disciplina</option>
<option value="Matem√°tica">Matem√°tica</option>
<option value="Portugu√™s">Portugu√™s</option>
<option value="F√≠sica">F√≠sica</option>
<option value="Qu√≠mica">Qu√≠mica</option>
<option value="Biologia">Biologia</option>
<option value="Hist√≥ria">Hist√≥ria</option>
<option value="Geografia">Geografia</option>
<option value="Ingl√™s">Ingl√™s</option>
<option value="Outra">Outra</option>
</select>
</div>

<div class="termo-box">
<p>
Ao realizar o cadastro, seus dados (nome, email, escola,
cidade e disciplina) ser√£o utilizados exclusivamente
para fins educacionais dentro do sistema.
</p>
<p>
Os dados n√£o s√£o compartilhados com terceiros.
</p>

<label class="checkbox-termo">
<input type="checkbox" id="aceite">
Declaro que li e concordo com os termos.
</label>
</div>

<button class="btn-login" onclick="cadastrar()">
Cadastrar
</button>

<p id="msg" class="msg-error"></p>

</div>

<script src="./js/conexao.js"></script>

<script>

// =========================
// UTILIT√ÅRIOS
// =========================
function limparErros(){
document.querySelectorAll(".input-erro")
.forEach(el=>el.classList.remove("input-erro"));
}

function validarCampo(id, mensagem){
const campo = document.getElementById(id);
if(!campo || !campo.value.trim()){
campo.classList.add("input-erro");
campo.focus();
mostrarErro(mensagem);
return false;
}
return true;
}

function mostrarErro(msg){
const el = document.getElementById("msg");
el.style.display = "block";
el.innerText = msg;
}

function mostrarSucesso(msg){
const el = document.getElementById("msg");
el.classList.remove("msg-error");
el.classList.add("msg-sucesso");
el.style.display = "block";
el.innerText = msg;
}

// =========================
// CIDADES RO
// =========================
async function verificarEstado(){

const estado = document.getElementById("estado").value;
const container = document.getElementById("cidadeContainer");

if(estado === "RO"){

container.innerHTML = `
<select id="cidadeSelect">
<option>Carregando cidades...</option>
</select>`;

try{

const resp = await fetch(
"https://servicodados.ibge.gov.br/api/v1/localidades/estados/RO/municipios"
);

const cidades = await resp.json();
const select = document.getElementById("cidadeSelect");

select.innerHTML = `<option value="">Selecione a Cidade</option>`;

cidades.sort((a,b)=>a.nome.localeCompare(b.nome));

cidades.forEach(c=>{
select.innerHTML += `<option value="${c.nome}">${c.nome}</option>`;
});

}catch(e){

container.innerHTML = `
<input type="text" id="cidadeManual"
placeholder="Cidade">`;
}

}else{

container.innerHTML = `
<input type="text" id="cidadeManual"
placeholder="Cidade">`;
}
}

// =========================
// CADASTRO
// =========================
async function cadastrar(){

limparErros();
document.getElementById("msg").style.display="none";

const nome = document.getElementById("nome").value.trim();
const email = document.getElementById("email").value.trim();
const senha = document.getElementById("senha").value.trim();
const escola = document.getElementById("escola").value.trim();
const estado = document.getElementById("estado").value;
const disciplina = document.getElementById("disciplina").value;
const aceitou = document.getElementById("aceite").checked;

let cidade = "";

if(estado === "RO"){
cidade = document.getElementById("cidadeSelect")?.value || "";
}else{
cidade = document.getElementById("cidadeManual")?.value || "";
}

if(!validarCampo("nome","Informe seu nome.")) return;
if(!validarCampo("email","Informe um email v√°lido.")) return;
if(!validarCampo("senha","Crie uma senha.")) return;
if(!validarCampo("escola","Informe sua escola.")) return;
if(!validarCampo("estado","Selecione o estado.")) return;

if(estado==="RO"){
if(!validarCampo("cidadeSelect","Selecione a cidade.")) return;
}else{
if(!validarCampo("cidadeManual","Informe a cidade.")) return;
}

if(!validarCampo("disciplina","Selecione a disciplina.")) return;

if(!aceitou){
mostrarErro("√â necess√°rio aceitar os termos.");
return;
}

// ===== BOT√ÉO LOADING =====
const btn = document.querySelector(".btn-login");
btn.classList.add("btn-loading");
btn.innerText = "Cadastrando...";
btn.disabled = true;

try{

const resposta = await fetch(API,{
method:"POST",
body:JSON.stringify({
tipo:"cadastro",
nome:nome,
email:email,
senha:senha,
escola:escola,
cidade:cidade,
estado:estado,
disciplina:disciplina
})
});

const dados = await resposta.json();

if(dados.mensagem){

btn.classList.remove("btn-loading");
btn.innerText = "Cadastro realizado ‚úî";
btn.disabled = true;

mostrarSucesso("Aguarde aprova√ß√£o do administrador. Voc√™ ser√° redirecionado em instantes...");

// ‚è≥ Atualiza ap√≥s 5 segundos
setTimeout(()=>{
    window.location.href = "index.html";
}, 5000);

return;

}else{
throw new Error(dados.erro || "Erro no cadastro.");
}

}catch(e){

btn.classList.remove("btn-loading");
btn.innerText="Cadastrar";
btn.disabled=false;
mostrarErro(e.message);

}
}

</script>
</body>
</html>
